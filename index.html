<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Электронное учебно-методическое пособие</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./styles/vars.css" />
    <link rel="stylesheet" href="./styles/styles.css" />
    <link rel="stylesheet" href="./styles/responsive.css" />
    <script src="script.js" defer></script>
  </head>
  <body>
    <header>
      <nav>
        <a href="#home" class="logo">STM32</a>
        <ul class="nav-links">
          <li class="link_item">
            <a href="./Pages/test.html" class="link">Тесты</a>
          </li>
          <li class="link_item">
            <a href="./Pages/labs.html" class="link">Лабораторные</a>
          </li>
          <li class="link_item">
            <a href="./Pages/videos.html" class="link">Видеоматериалы</a>
          </li>
        </ul>
        <div class="burger">
          <span></span>
        </div>
      </nav>
    </header>
    <main>
      <div class="container accordion">
        <h2>Программирование STM32. Автор: DiMoon</h2>
        <div class="accordion-item">
          <div class="accordion-header">Часть 1 - Документация</div>
          <div class="accordion-content">
            <p>
              Начало знакомства с любой вещью лучше всего начинать с инструкции.
              В некоторых случаях ясно все и так, в других — «хм, ничего не
              работает, похоже все-таки надо почитать инструкцию».
              Микроконтроллеры — устройства достаточно сложные, и без прочтения
              документации с ними уж точно ничего полезного не сделаешь, хотя…
            </p>
            <p>
              В этой статье мы рассмотрим, как на&nbsp;официальном сайте
              производителя организована документация на микроконтроллеры STM32,
              в частности на серию STM32F1.
            </p>
            <p>
              После каких-нибудь AVR-ок, можно испытать легкий шок от количества
              разных PDF-ок на микроконтроллеры STM32. Куда глядеть первым
              делом? Как этим пользоваться? Что ваще происходит?? С первого
              взгляда ни чего не понятно. Поэтому я решил сделать небольшой
              обзор мира документации на эти замечательные микроконтроллеры.
              Особый упор буду делать на&nbsp;STM32F103C8T6, так как далее
              планирую написать несколько уроков по использованию именно этого
              камушка.
            </p>
            <p>Основными документами на STM-ки являются следующие:</p>
            <ol>
              <li>Datasheet</li>
              <li>Reference manual</li>
              <li>Programming Manual</li>
              <li>Errata Sheet</li>
            </ol>
            <h2>Datasheet</h2>
            <p>
              Datasheet содержит в себе информацию о наличии определенной
              периферии в конкретном МК, цоколевке, электрических
              характеристиках и маркировке чипов для STM32F103x8
              и&nbsp;STM32F103xB, то есть для вот этих, которые обведены красным
              прямоугольником:
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-494 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/en.STM32F103_line_LN1565.jpg"
                alt=""
                width="700"
                height="392"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/en.STM32F103_line_LN1565.jpg         700w,
                  http://dimoon.ru/wp-content/uploads/2018/08/en.STM32F103_line_LN1565-300x168.jpg 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/en.STM32F103_line_LN1565-250x140.jpg 250w,
                  http://dimoon.ru/wp-content/uploads/2018/08/en.STM32F103_line_LN1565-150x84.jpg  150w
                "
                sizes="(max-width: 700px) 100vw, 700px"
              />
            </p>
            <p>Некисло, один даташит на 8 микроконтроллеров.</p>
            <h3>Основное в&nbsp;Datasheet-е</h3>
            <p>
              В первую очередь нужно обратить внимание на раздел&nbsp;<em
                >7.&nbsp;Ordering information scheme</em
              >, в котором указано, то обозначает каждый символ в маркировке.
              Например, для STM32F103C8T6: корпус&nbsp; LQFP-48, 64Кб flash-а,
              температурный диапазон&nbsp;–40 to 85 °C.
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-496 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/ris4.png"
                alt=""
                width="474"
                height="615"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/ris4.png         474w,
                  http://dimoon.ru/wp-content/uploads/2018/08/ris4-231x300.png 231w,
                  http://dimoon.ru/wp-content/uploads/2018/08/ris4-116x150.png 116w
                "
                sizes="(max-width: 474px) 100vw, 474px"
              />
            </p>
            <p>
              Далее&nbsp;<em>2.1 Device overview</em>. В нем есть таблица, в
              которой сказано, какая периферия есть в конкретном
              микроконтроллере и в каком количестве:
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-497 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/ris5.png"
                alt=""
                width="708"
                height="720"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/ris5.png         708w,
                  http://dimoon.ru/wp-content/uploads/2018/08/ris5-295x300.png 295w,
                  http://dimoon.ru/wp-content/uploads/2018/08/ris5-148x150.png 148w
                "
                sizes="(max-width: 708px) 100vw, 708px"
              />
            </p>
            <p>
              Основное различие между микроконтроллерами из разных колонок в
              количестве ножек и объеме флеша, остальное все одинаково.
              Небольшое исключение составляет первая колонка
              версий&nbsp;<strong>Tx</strong>: в этих микроконтроллерах поменьше
              модулей SPI, I2C и USART-ов. Нумерация периферии идет с единицы:
              то есть, если в&nbsp;STM32F103<strong>Cx</strong> у нас 2 SPI, то
              они имеют имена SPI1 и SPI2, а в&nbsp;STM32F103<strong>Tx</strong>
              у нас только SPI1. Так как&nbsp;Datasheet у нас на
              микроконтроллеры&nbsp;STM32F103x8 и&nbsp;STM32F103xB, то эта
              таблица справедлива только для этих моделей. К
              примеру&nbsp;STM32F103<strong>C8</strong>&nbsp;или&nbsp;STM32F103<strong
                >CB</strong
              >
              соответствуют этой таблице,
              а&nbsp;STM32F103<strong>C6</strong>&nbsp;нет, для него есть
              отдельный даташит.
            </p>
            <p>
              В разделе&nbsp;<em
                >2.2 Full compatibility throughout the family</em
              >
              говорится о том, что устройства&nbsp;STM32F103xx являются
              программно, функционально и&nbsp;pin-to-pin (для одинаковых
              корпусов) совместимыми.
            </p>
            <p>
              В&nbsp;reference manual-е&nbsp;есть разделение на следующие «виды»
              микроконтроллеров:&nbsp;STM32F103x4 и STM32F103x6 обозначены как
              <strong><em>low-density devices</em></strong
              >, STM32F103x8 и STM32F103xB как
              <strong><em>medium-density devices</em></strong
              >, STM32F103xC, STM32F103xD и STM32F103xE как
              <strong><em>high-density devices</em></strong
              >. В устройствах Low-density devices меньше Flash и RAM памяти,
              таймеров и периферийных устройств.&nbsp;High-density devices имеют
              больший объем Flash и RAM памяти, а так же имеют дополнительную
              периферию, такую как&nbsp;SDIO, FSMC, I2S и DAC, при этом
              оставаясь полностью совместимыми с другими представителями
              семейства&nbsp;STM32F103xx. То есть, если на каком-то этапе
              разработки стало ясно, что выбранного микроконтроллера не хватает
              для реализации всех возможностей, то можно безболезненно выбрать
              более навороченный камень без необходимости переписывать весь
              существующий софт, при этом, если новый камень будет в том же
              корпусе, то отпадает необходимость заново разводить печатную
              плату.
            </p>
            <h2>Reference manual</h2>
            <p>
              Поехали далее.&nbsp;Reference manual (справочное руководство)
              содержит подробное описание всей периферии, регистров, смещений, и
              так далее. Это основной документ, который используется при
              создании прошивки под микроконтроллер.&nbsp;Reference manual
              составлен для большой группы микроконтроллеров, в нашем случае для
              всех STM32F10xxx, а именно&nbsp;STM32F101xx, STM32F102xx,
              STM32F103xx и STM32F105xx/STM32F107xx. Но STM32F100xx не входят в
              этот RM, для них есть свой.
            </p>
            <h3>Главное в&nbsp;Reference manual-е</h3>
            <p>
              Как было сказано выше, в reference manual-е есть разделение на
              следующие «виды» микроконтроллеров:&nbsp;low-, medium-,
              high-density и connectivity<br />
              line. В <em>2.3&nbsp;Glossary</em> разъяснено, кто есть кто:
            </p>
            <ul>
              <li>
                <strong>Low-density devices</strong> это STM32F101xx,
                STM32F102xx и STM32F103xx микроконтроллеры, у которых размер
                Flash-памяти находится между 16 и 32 Kbytes.
              </li>
              <li>
                <strong>Medium-density devices</strong> это STM32F101xx,
                STM32F102xx and STM32F103xx, размер&nbsp;флеш-памяти
                между&nbsp;64 и 128 Kbytes.
              </li>
              <li>
                <strong>High-density devices</strong> это STM32F101xx и
                STM32F103xx, размер&nbsp;флеш-памяти между&nbsp;256 и 512
                Kbytes.
              </li>
              <li>
                <strong>XL-density devices</strong> это STM32F101xx и
                STM32F103xx, размер&nbsp;флеш-памяти между&nbsp;768 Kbytes и 1
                Mbyte.
              </li>
              <li>
                <strong>Connectivity line devices</strong> это микроконтроллеры
                STM32F105xx и STM32F107xx.
              </li>
            </ul>
            <p>
              Наш&nbsp;STM32F103C8T6 является&nbsp;Medium-density device-ом. Это
              будет полезно знать при изучении периферии, например, есть
              отдельные разделы про RCC для&nbsp;Low-, medium-, high- and
              XL-density устройств, и&nbsp;Connectivity line devices.
            </p>
            <p>
              Далее обратимся к Tabe 1. В ней отмечено, какой раздел применим к
              конкретному типу микроконтроллеров. У нас это&nbsp;Medium-density
              STM32F103xx:
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-499 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/ris6.png"
                alt=""
                width="805"
                height="1686"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/ris6.png          805w,
                  http://dimoon.ru/wp-content/uploads/2018/08/ris6-143x300.png  143w,
                  http://dimoon.ru/wp-content/uploads/2018/08/ris6-768x1609.png 768w,
                  http://dimoon.ru/wp-content/uploads/2018/08/ris6-489x1024.png 489w,
                  http://dimoon.ru/wp-content/uploads/2018/08/ris6-72x150.png    72w
                "
                sizes="(max-width: 805px) 100vw, 805px"
              />
            </p>
            <p>
              Далее все просто: идет куча разделов, в каждом из которых
              содержится описание на конкретную периферию и ее регистры
            </p>
            <h2>Programming Manual</h2>
            <p>
              Programming Manual не является документом первой необходимости в
              самом начале знакомства с STM-ми, однако является очень важным при
              углубленном изучении этих микроконтроллеров. Он содержит
              информацию о процессорном ядре, системе команд и периферии ядра.
              Причем это не та же самая периферия, которая описана
              в&nbsp;Reference manual-е.&nbsp; В нее входят:
            </p>
            <ul>
              <li>System timer — системный таймер</li>
              <li>
                Nested vectored interrupt controller — контроллер приоритетных
                прерываний
              </li>
              <li>System control block</li>
              <li>Memory protection unit</li>
            </ul>
            <p>
              Как только мы начнем знакомится с прерываниями в STM32, нам
              понадобится раздел&nbsp;<em
                >4.3 Nested vectored interrupt controller (NVIC)</em
              >. Ну и системный таймер является очень прикольной вещью, который
              будет полезен в каких-нибудь RTOS или для создания программных
              таймеров.
            </p>
            <h2>Errata Sheet</h2>
            <p>
              Errata Sheet — сборник всех известных аппаратных глюков и косяков
              микроконтроллеров и советов, как их обойти. Довольно веселый
              документ Перед использованием какой-либо периферии, советую суда
              заглянуть. Это может помочь сократить количество потерянных
              нервных клеток при отладке своей чудо-прошивки, которая ни как не
              хочет работать
            </p>
          </div>
        </div>
        <div class="accordion-item">
          <div class="accordion-header">Часть 2: IAR + CMSIS</div>
          <div class="accordion-content">
            <h2>Введение</h2>
            <p>
              Cortex Microcontroller Software Interface Standard
              (CMSIS)&nbsp;содержит описание всех регистров микроконтроллера,
              таблицу векторов прерываний и некоторый стартовый код, который
              выполняется перед передачей управления функции main(). Вообще
              говоря, СMSIS является необязательным компонентом проекта, однако,
              в этом случае придется самому заботиться об огромном количестве
              вещей. Кроме того, эта библиотека позволяет писать в некоторой
              степени переносимый код с одного микроконтроллера, на другой.
            </p>
            <h2>Качаем CMSIS</h2>
            <p>
              В данный момент CMSIS поставляется совместно с&nbsp;STM32Cube MCU
              Package. Скачать его можно на странице выбранного микроконтроллера
              (там, где качали даташит, Reference manual и так далее),
              называется&nbsp;STM32CubeF1:
            </p>
            <p>
              <img
                class="aligncenter size-large wp-image-511 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/img1-1024x110.png"
                alt=""
                width="830"
                height="89"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/img1-1024x110.png 1024w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img1-300x32.png    300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img1-768x82.png    768w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img1-250x27.png    250w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img1-150x16.png    150w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img1.png          1278w
                "
                sizes="(max-width: 830px) 100vw, 830px"
              />
            </p>
            <p>
              Для скачивания нужно зарегистрироваться у них на сайте. Феее, ну и
              нафига они это сделали?:\ Оставлю ка я ссылку на архив в конце
              статьи, чтоб не возится во всеми этими регистрациями. Но все же
              лучше скачать актуальную версию библиотеки на официальном сайте.
              Весит архив к стати довольно много, 97 метров.
            </p>
            <h2>Создаем проект в IAR ARM</h2>
            <p>
              Теперь проводим небольшую подготовительную работу по созданию
              проекта в IAR ARM. Запускаем среду&nbsp;IAR Embedded Workbench:
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-513 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/img0.png"
                alt=""
                width="765"
                height="542"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/img0.png         765w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img0-300x213.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img0-212x150.png 212w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img0-150x106.png 150w
                "
                sizes="(max-width: 765px) 100vw, 765px"
              />
            </p>
            <p>
              В IAR-e все проекты (Projects) находятся внутри Workspace-а,
              причем количество проектов в одном воркспейсе может быть
              несколько.
            </p>
            <p>Выбираем <em>Project-&gt;Create New Project…</em></p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-514 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/img1-1.png"
                alt=""
                width="765"
                height="756"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/img1-1.png         765w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img1-1-300x296.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img1-1-152x150.png 152w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img1-1-150x148.png 150w
                "
                sizes="(max-width: 765px) 100vw, 765px"
              />
            </p>
            <p>В открывшемся окне выбираем тип проекта: <em>C-&gt;main</em>:</p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-515 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/img2.png"
                alt=""
                width="394"
                height="336"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/img2.png         394w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img2-300x256.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img2-176x150.png 176w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img2-150x128.png 150w
                "
                sizes="(max-width: 394px) 100vw, 394px"
              />
            </p>
            <p>
              Нажимаем ОК, набираем какое-нибудь имя (в моем случае
              <em>test_proj</em>) и сохраняем в какой-нибудь папке:
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-536 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-33-15.png"
                alt=""
                width="611"
                height="489"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-33-15.png         611w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-33-15-300x240.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-33-15-187x150.png 187w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-33-15-150x120.png 150w
                "
                sizes="(max-width: 611px) 100vw, 611px"
              />Проект создан.&nbsp;После этого выбираем
              <em>File-&gt;Save All</em> и в открывшемся окне набираем имя
              нашего&nbsp;Workspace-а, его можно назвать так же, как и проект.
            </p>
            <p>
              Теперь нам надо настроить проект под конкретный микроконтроллер, а
              именно <em>STM32F103C8</em>. Нажимаем правой кнопкой мыши на
              названии нашего проекта и выбираем пункт <em>Options…</em>
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-516 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/img4.png"
                alt=""
                width="765"
                height="756"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/img4.png         765w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img4-300x296.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img4-152x150.png 152w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img4-150x148.png 150w
                "
                sizes="(max-width: 765px) 100vw, 765px"
              />
            </p>
            <p>
              В разделе<em> General Options</em> на вкладке
              <em>Target</em> выбираем наш микроконтроллер:
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-518 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/img5.png"
                alt=""
                width="536"
                height="493"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/img5.png         536w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img5-300x276.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img5-163x150.png 163w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img5-150x138.png 150w
                "
                sizes="(max-width: 536px) 100vw, 536px"
              />
            </p>
            <p>
              Далее настаиваем уровень оптимизации компиляции. При отладке
              иногда натыкался на некоторые проблемы при высоком уровне
              оптимизации, поэтому советую в <em>C/C++ Compiler</em> на вкладке
              <em>Optimizations</em>&nbsp;ставить&nbsp;<em>None&nbsp;</em>или на
              крайняк <em>Low</em>:
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-519 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/img6.png"
                alt=""
                width="536"
                height="502"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/img6.png         536w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img6-300x281.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img6-160x150.png 160w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img6-150x140.png 150w
                "
                sizes="(max-width: 536px) 100vw, 536px"
              />
            </p>
            <p>
              Складывать все файлы исходников в корень проекта не очень хорошая
              идея, в дальнейшем будет трудно ориентироваться среди кучи файлов,
              поэтому для CMSIS создадим одноименную папку <em>CMSIS</em> . Но
              нам необходимо указать компилятору путь, где искать исходники. Для
              этого на вкладке <em>Preprocessor </em>надо указать путь к папке с
              библиотекой. Чтоб не указывать абсолютные пути, в IAR-е существует
              переменная $PROJ_DIR$, в которой хранится путь к папке с
              проектом:<br />
            </p>
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div><span class="enlighter-text">$PROJ_DIR$\</span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text">$PROJ_DIR$\CMSIS\</span>
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">$PROJ_DIR$\ $PROJ_DIR$\CMSIS\</div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="default"
              data-enlighter-title=""
            >
$PROJ_DIR$\
$PROJ_DIR$\CMSIS\</pre
            >
            <br />
            Первая строчка указывает на корень проекта, где лежит main.c, это
            вроде как не обязательно, но пусть будет, вторая на будущую папку с
            CMSIS. Обращаем внимание на стрелки прокрутки вкладок, выделил
            синим:
            <p></p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-520 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/img7.png"
                alt=""
                width="536"
                height="502"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/img7.png         536w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img7-300x281.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img7-160x150.png 160w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img7-150x140.png 150w
                "
                sizes="(max-width: 536px) 100vw, 536px"
              />
            </p>
            <p>
              Теперь отладчик. В разделе <em>Debugger</em> на вкладке
              <em>Setup</em> выбираем <em>ST-LINK, </em>который идет в комплекте
              с отладочными платами Discovery:
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-522 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/img9.png"
                alt=""
                width="561"
                height="502"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/img9.png         561w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img9-300x268.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img9-168x150.png 168w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img9-150x134.png 150w
                "
                sizes="(max-width: 561px) 100vw, 561px"
              />
            </p>
            <p>
              и на вкладке <em>Download</em> ставим галочку
              <em>Use flash loader(s)</em>:
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-523 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/img10.png"
                alt=""
                width="561"
                height="502"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/img10.png         561w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img10-300x268.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img10-168x150.png 168w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img10-150x134.png 150w
                "
                sizes="(max-width: 561px) 100vw, 561px"
              />
            </p>
            <p>
              После этого в разделе <em>ST-LINK</em> выбираем тип интерфейса
              подключения, у нас по&nbsp;<em>SWD</em>:
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-524 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/img11.png"
                alt=""
                width="582"
                height="502"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/img11.png         582w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img11-300x259.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img11-174x150.png 174w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img11-150x129.png 150w
                "
                sizes="(max-width: 582px) 100vw, 582px"
              />
            </p>
            <p>Фух, проект настроили. Нажимаем OK для сохранения изменений.</p>
            <p>
              После этого идем в каталог с проектом и создаем там папку
              <em>CMSIS</em>, в нее мы будем складывать файлы библиотеки
              CMSIS<em>:</em>
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-525 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/img12.png"
                alt=""
                width="473"
                height="261"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/img12.png         473w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img12-300x166.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img12-250x138.png 250w,
                  http://dimoon.ru/wp-content/uploads/2018/08/img12-150x83.png  150w
                "
                sizes="(max-width: 473px) 100vw, 473px"
              />
            </p>
            <h2>Библиотека CMSIS</h2>
            <p>
              Архив с&nbsp;STM32CubeF1 скачали, разархивировали. В нем
              содержится много разных вещей: документация, примеры для
              отладочных плат, драйверы HAL и сам&nbsp;CMSIS, который нам и
              нужен. CMSIS расположен в .\STM32Cube_FW_F1_V1.6.0\Drivers\CMSIS.
            </p>
            <p>Вначале идем в&nbsp;.\CMSIS\Device\ST\STM32F1xx\Include:</p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-526 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_23-34-35.png"
                alt=""
                width="440"
                height="381"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_23-34-35.png         440w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_23-34-35-300x260.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_23-34-35-173x150.png 173w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_23-34-35-150x130.png 150w
                "
                sizes="(max-width: 440px) 100vw, 440px"
              />
            </p>
            <p>
              У нас тут куча .h файлов для разных микроконтроллеров, но
              чего-нибудь наподобие stm32f103x8.h не видно.
              Открываем&nbsp;stm32f1xx.h. Там есть вот такая вещь:<br />
            </p>
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-k4"
                      >#if !defined (STM32F100xB) &amp;&amp; !defined
                      (STM32F100xE) &amp;&amp; !defined (STM32F101x6) &amp;&amp;
                      \</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> !</span
                    ><span class="enlighter-m0">defined</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">STM32F101xB</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> &amp;&amp; !</span
                    ><span class="enlighter-m0">defined</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">STM32F101xE</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> &amp;&amp; !</span
                    ><span class="enlighter-m0">defined</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">STM32F101xG</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> &amp;&amp; !</span
                    ><span class="enlighter-m0">defined</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">STM32F102x6</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> &amp;&amp; !</span
                    ><span class="enlighter-m0">defined</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">STM32F102xB</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> &amp;&amp; !</span
                    ><span class="enlighter-m0">defined</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">STM32F103x6</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> &amp;&amp; \</span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> !</span
                    ><span class="enlighter-m0">defined</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">STM32F103xB</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> &amp;&amp; !</span
                    ><span class="enlighter-m0">defined</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">STM32F103xE</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> &amp;&amp; !</span
                    ><span class="enlighter-m0">defined</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">STM32F103xG</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> &amp;&amp; !</span
                    ><span class="enlighter-m0">defined</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">STM32F105xC</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> &amp;&amp; !</span
                    ><span class="enlighter-m0">defined</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">STM32F107xC</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F100xB */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F100C4, STM32F100R4, STM32F100C6,
                      STM32F100R6, STM32F100C8, STM32F100R8, STM32F100V8,
                      STM32F100CB, STM32F100RB and STM32F100VB */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F100xE */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F100RC, STM32F100VC, STM32F100ZC,
                      STM32F100RD, STM32F100VD, STM32F100ZD, STM32F100RE,
                      STM32F100VE and STM32F100ZE */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F101x6 */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F101C4, STM32F101R4, STM32F101T4,
                      STM32F101C6, STM32F101R6 and STM32F101T6 Devices */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F101xB */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F101C8, STM32F101R8, STM32F101T8,
                      STM32F101V8, STM32F101CB, STM32F101RB, STM32F101TB and
                      STM32F101VB */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F101xE */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F101RC, STM32F101VC, STM32F101ZC,
                      STM32F101RD, STM32F101VD, STM32F101ZD, STM32F101RE,
                      STM32F101VE and STM32F101ZE */</span
                    ><span class="enlighter-text"> </span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F101xG */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F101RF, STM32F101VF, STM32F101ZF,
                      STM32F101RG, STM32F101VG and STM32F101ZG */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F102x6 */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F102C4, STM32F102R4, STM32F102C6 and
                      STM32F102R6 */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F102xB */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F102C8, STM32F102R8, STM32F102CB and
                      STM32F102RB */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F103x6 */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F103C4, STM32F103R4, STM32F103T4,
                      STM32F103C6, STM32F103R6 and STM32F103T6 */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="enlighter-special">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F103xB */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F103C8, STM32F103R8, STM32F103T8,
                      STM32F103V8, STM32F103CB, STM32F103RB, STM32F103TB and
                      STM32F103VB */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F103xE */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F103RC, STM32F103VC, STM32F103ZC,
                      STM32F103RD, STM32F103VD, STM32F103ZD, STM32F103RE,
                      STM32F103VE and STM32F103ZE */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F103xG */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F103RF, STM32F103VF, STM32F103ZF,
                      STM32F103RG, STM32F103VG and STM32F103ZG */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F105xC */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F105R8, STM32F105V8, STM32F105RB,
                      STM32F105VB, STM32F105RC and STM32F105VC */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F107xC */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F107RB, STM32F107VB, STM32F107RC and
                      STM32F107VC */</span
                    ><span class="enlighter-text"> </span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4">#endif</span>
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                #if !defined (STM32F100xB) &amp;&amp; !defined (STM32F100xE)
                &amp;&amp; !defined (STM32F101x6) &amp;&amp; \ !defined
                (STM32F101xB) &amp;&amp; !defined (STM32F101xE) &amp;&amp;
                !defined (STM32F101xG) &amp;&amp; !defined (STM32F102x6)
                &amp;&amp; !defined (STM32F102xB) &amp;&amp; !defined
                (STM32F103x6) &amp;&amp; \ !defined (STM32F103xB) &amp;&amp;
                !defined (STM32F103xE) &amp;&amp; !defined (STM32F103xG)
                &amp;&amp; !defined (STM32F105xC) &amp;&amp; !defined
                (STM32F107xC) /* #define STM32F100xB */ /*!&lt; STM32F100C4,
                STM32F100R4, STM32F100C6, STM32F100R6, STM32F100C8, STM32F100R8,
                STM32F100V8, STM32F100CB, STM32F100RB and STM32F100VB */ /*
                #define STM32F100xE */ /*!&lt; STM32F100RC, STM32F100VC,
                STM32F100ZC, STM32F100RD, STM32F100VD, STM32F100ZD, STM32F100RE,
                STM32F100VE and STM32F100ZE */ /* #define STM32F101x6 */ /*!&lt;
                STM32F101C4, STM32F101R4, STM32F101T4, STM32F101C6, STM32F101R6
                and STM32F101T6 Devices */ /* #define STM32F101xB */ /*!&lt;
                STM32F101C8, STM32F101R8, STM32F101T8, STM32F101V8, STM32F101CB,
                STM32F101RB, STM32F101TB and STM32F101VB */ /* #define
                STM32F101xE */ /*!&lt; STM32F101RC, STM32F101VC, STM32F101ZC,
                STM32F101RD, STM32F101VD, STM32F101ZD, STM32F101RE, STM32F101VE
                and STM32F101ZE */ /* #define STM32F101xG */ /*!&lt;
                STM32F101RF, STM32F101VF, STM32F101ZF, STM32F101RG, STM32F101VG
                and STM32F101ZG */ /* #define STM32F102x6 */ /*!&lt;
                STM32F102C4, STM32F102R4, STM32F102C6 and STM32F102R6 */ /*
                #define STM32F102xB */ /*!&lt; STM32F102C8, STM32F102R8,
                STM32F102CB and STM32F102RB */ /* #define STM32F103x6 */ /*!&lt;
                STM32F103C4, STM32F103R4, STM32F103T4, STM32F103C6, STM32F103R6
                and STM32F103T6 */ /* #define STM32F103xB */ /*!&lt;
                STM32F103C8, STM32F103R8, STM32F103T8, STM32F103V8, STM32F103CB,
                STM32F103RB, STM32F103TB and STM32F103VB */ /* #define
                STM32F103xE */ /*!&lt; STM32F103RC, STM32F103VC, STM32F103ZC,
                STM32F103RD, STM32F103VD, STM32F103ZD, STM32F103RE, STM32F103VE
                and STM32F103ZE */ /* #define STM32F103xG */ /*!&lt;
                STM32F103RF, STM32F103VF, STM32F103ZF, STM32F103RG, STM32F103VG
                and STM32F103ZG */ /* #define STM32F105xC */ /*!&lt;
                STM32F105R8, STM32F105V8, STM32F105RB, STM32F105VB, STM32F105RC
                and STM32F105VC */ /* #define STM32F107xC */ /*!&lt;
                STM32F107RB, STM32F107VB, STM32F107RC and STM32F107VC */ #endif
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="c"
              data-enlighter-highlight="13"
              data-enlighter-title=""
            >
#if !defined (STM32F100xB) &amp;&amp; !defined (STM32F100xE) &amp;&amp; !defined (STM32F101x6) &amp;&amp; \
    !defined (STM32F101xB) &amp;&amp; !defined (STM32F101xE) &amp;&amp; !defined (STM32F101xG) &amp;&amp; !defined (STM32F102x6) &amp;&amp; !defined (STM32F102xB) &amp;&amp; !defined (STM32F103x6) &amp;&amp; \
    !defined (STM32F103xB) &amp;&amp; !defined (STM32F103xE) &amp;&amp; !defined (STM32F103xG) &amp;&amp; !defined (STM32F105xC) &amp;&amp; !defined (STM32F107xC)
  /* #define STM32F100xB  */   /*!&lt; STM32F100C4, STM32F100R4, STM32F100C6, STM32F100R6, STM32F100C8, STM32F100R8, STM32F100V8, STM32F100CB, STM32F100RB and STM32F100VB */
  /* #define STM32F100xE */    /*!&lt; STM32F100RC, STM32F100VC, STM32F100ZC, STM32F100RD, STM32F100VD, STM32F100ZD, STM32F100RE, STM32F100VE and STM32F100ZE */
  /* #define STM32F101x6  */   /*!&lt; STM32F101C4, STM32F101R4, STM32F101T4, STM32F101C6, STM32F101R6 and STM32F101T6 Devices */
  /* #define STM32F101xB  */   /*!&lt; STM32F101C8, STM32F101R8, STM32F101T8, STM32F101V8, STM32F101CB, STM32F101RB, STM32F101TB and STM32F101VB */
  /* #define STM32F101xE */    /*!&lt; STM32F101RC, STM32F101VC, STM32F101ZC, STM32F101RD, STM32F101VD, STM32F101ZD, STM32F101RE, STM32F101VE and STM32F101ZE */ 
  /* #define STM32F101xG  */   /*!&lt; STM32F101RF, STM32F101VF, STM32F101ZF, STM32F101RG, STM32F101VG and STM32F101ZG */
  /* #define STM32F102x6 */    /*!&lt; STM32F102C4, STM32F102R4, STM32F102C6 and STM32F102R6 */
  /* #define STM32F102xB  */   /*!&lt; STM32F102C8, STM32F102R8, STM32F102CB and STM32F102RB */
  /* #define STM32F103x6  */   /*!&lt; STM32F103C4, STM32F103R4, STM32F103T4, STM32F103C6, STM32F103R6 and STM32F103T6 */
  /* #define STM32F103xB  */   /*!&lt; STM32F103C8, STM32F103R8, STM32F103T8, STM32F103V8, STM32F103CB, STM32F103RB, STM32F103TB and STM32F103VB */
  /* #define STM32F103xE */    /*!&lt; STM32F103RC, STM32F103VC, STM32F103ZC, STM32F103RD, STM32F103VD, STM32F103ZD, STM32F103RE, STM32F103VE and STM32F103ZE */
  /* #define STM32F103xG  */   /*!&lt; STM32F103RF, STM32F103VF, STM32F103ZF, STM32F103RG, STM32F103VG and STM32F103ZG */
  /* #define STM32F105xC */    /*!&lt; STM32F105R8, STM32F105V8, STM32F105RB, STM32F105VB, STM32F105RC and STM32F105VC */
  /* #define STM32F107xC  */   /*!&lt; STM32F107RB, STM32F107VB, STM32F107RC and STM32F107VC */  
#endif</pre
            >
            <br />
            Обращаем внимание на строчку:<br />
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-c1">/* #define STM32F103xB */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F103C8, STM32F103R8, STM32F103T8,
                      STM32F103V8, STM32F103CB, STM32F103RB, STM32F103TB and
                      STM32F103VB */</span
                    >
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                /* #define STM32F103xB */ /*!&lt; STM32F103C8, STM32F103R8,
                STM32F103T8, STM32F103V8, STM32F103CB, STM32F103RB, STM32F103TB
                and STM32F103VB */
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="default"
              data-enlighter-title=""
            >
/* #define STM32F103xB  */   /*!&lt; STM32F103C8, STM32F103R8, STM32F103T8, STM32F103V8, STM32F103CB, STM32F103RB, STM32F103TB and STM32F103VB */</pre
            >
            <br />
            Ага,&nbsp;STM32F103C8 тут есть. Значит для нашего микроконтроллера
            подойдут исходники, от
            <em>B</em> версии:&nbsp;STM32<strong>F103xB</strong>.&nbsp;Запомним
            это. Из этой папки копируем в CMSIS проекта следующие файлы:<br />
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-text">stm32f1xx.</span
                    ><span class="enlighter-m3">h</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text">stm32f103xb.</span
                    ><span class="enlighter-m3">h</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text">system_stm32f1xx.</span
                    ><span class="enlighter-m3">h</span>
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                stm32f1xx.h stm32f103xb.h system_stm32f1xx.h
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="default"
              data-enlighter-title=""
            >
stm32f1xx.h
stm32f103xb.h
system_stm32f1xx.h</pre
            >
            <br />
            Далее переходим в
            <em>.\CMSIS\Device\ST\STM32F1xx\Source\Templates</em> и отсюда
            забираем файл <em>system_stm32f1xx.c</em>
            <p></p>
            <p>
              После нам нужен стартап-файл. Заходим в&nbsp;<em
                >.\CMSIS\Device\ST\STM32F1xx\Source\Templates\iar. </em
              >Там нас так же ждет большое количество файлов и мы так же ищем
              тот, который оканчивается на
              <em>xB</em
              >:&nbsp;<em>startup_stm32f103<strong>xb</strong>.s.&nbsp;</em>Копируем
              его в&nbsp;<em>$PROJ_DIR$\CMSIS\.</em>
            </p>
            <p>
              Затем переходим в&nbsp;<em>.\CMSIS\Include&nbsp;</em>и забираем
              вот эти 3 файла:<br />
            </p>
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-text">core_cm3.</span
                    ><span class="enlighter-m3">h</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text">core_cmFunc.</span
                    ><span class="enlighter-m3">h</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text">core_cmInstr.</span
                    ><span class="enlighter-m3">h</span>
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                core_cm3.h core_cmFunc.h core_cmInstr.h
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="default"
              data-enlighter-title=""
            >
core_cm3.h
core_cmFunc.h
core_cmInstr.h</pre
            >
            <br />
            Так как в&nbsp;<em>STM32F103C8</em> микропроцессорное ядро
            <em>Cortex M3</em>, то и берем соответствующие исходники.
            <p></p>
            <p>Итого 8 файлов:</p>
            <ol>
              <li><em>stm32f1xx.h</em></li>
              <li><em>stm32f103<strong>xb</strong>.h</em></li>
              <li><em>system_stm32f1xx.h</em></li>
              <li><em>system_stm32f1xx.c</em></li>
              <li><em>startup_stm32f103<strong>xb</strong>.s</em></li>
              <li><em>core_cm3.h</em></li>
              <li><em>core_cmFunc.h</em></li>
              <li><em>core_cmInstr.h</em></li>
            </ol>
            <p>
              Вот так это должно выглядеть в папке&nbsp;<em
                >$PROJ_DIR$\CMSIS:</em
              >
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-529 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-44-29-1.png"
                alt=""
                width="499"
                height="213"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-44-29-1.png         499w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-44-29-1-300x128.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-44-29-1-250x107.png 250w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-44-29-1-150x64.png  150w
                "
                sizes="(max-width: 499px) 100vw, 499px"
              />
            </p>
            <p>
              Теперь эти файлы надо добавить в обозреватель проекта в IAR-е. Для
              удобства создадим группу с одноименным названием CMSIS. Нажимаем
              правой кнопкой мыши на названии проекта и выбираем
              <em>Add-&gt;Add Group…</em>
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-530 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-45-22.png"
                alt=""
                width="765"
                height="535"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-45-22.png         765w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-45-22-300x210.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-45-22-214x150.png 214w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-45-22-150x105.png 150w
                "
                sizes="(max-width: 765px) 100vw, 765px"
              />
            </p>
            <p>Вводим название группы и нажимаем <em>OK</em>:</p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-531 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/2018-08-05_00-06-31.png"
                alt=""
                width="281"
                height="102"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-05_00-06-31.png        281w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-05_00-06-31-250x91.png 250w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-05_00-06-31-150x54.png 150w
                "
                sizes="(max-width: 281px) 100vw, 281px"
              />
            </p>
            <p>После этого в группу CMSIS добавляем файлы из папки CMSIS:</p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-532 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-46-02.png"
                alt=""
                width="765"
                height="565"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-46-02.png         765w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-46-02-300x222.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-46-02-203x150.png 203w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-46-02-150x111.png 150w
                "
                sizes="(max-width: 765px) 100vw, 765px"
              />
            </p>
            <p>
              В открывшемся диалоге выбираем все файлы и нажимаем
              <em>Открыть</em>:
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-537 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/2018-08-05_13-40-58.png"
                alt=""
                width="611"
                height="489"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-05_13-40-58.png         611w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-05_13-40-58-300x240.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-05_13-40-58-187x150.png 187w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-05_13-40-58-150x120.png 150w
                "
                sizes="(max-width: 611px) 100vw, 611px"
              />
            </p>
            <p>В результате получаем вот это:</p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-533 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-46-46.png"
                alt=""
                width="329"
                height="547"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-46-46.png         329w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-46-46-180x300.png 180w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-46-46-90x150.png   90w
                "
                sizes="(max-width: 329px) 100vw, 329px"
              />
            </p>
            <p>
              После этого открываем файл&nbsp;stm32f1xx.h и раскомментируем
              стоку с #define STM32F103xB:<br />
            </p>
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-k4"
                      >#if !defined (STM32F100xB) &amp;&amp; !defined
                      (STM32F100xE) &amp;&amp; !defined (STM32F101x6) &amp;&amp;
                      \</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> !</span
                    ><span class="enlighter-m0">defined</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">STM32F101xB</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> &amp;&amp; !</span
                    ><span class="enlighter-m0">defined</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">STM32F101xE</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> &amp;&amp; !</span
                    ><span class="enlighter-m0">defined</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">STM32F101xG</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> &amp;&amp; !</span
                    ><span class="enlighter-m0">defined</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">STM32F102x6</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> &amp;&amp; !</span
                    ><span class="enlighter-m0">defined</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">STM32F102xB</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> &amp;&amp; !</span
                    ><span class="enlighter-m0">defined</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">STM32F103x6</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> &amp;&amp; \</span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> !</span
                    ><span class="enlighter-m0">defined</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">STM32F103xB</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> &amp;&amp; !</span
                    ><span class="enlighter-m0">defined</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">STM32F103xE</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> &amp;&amp; !</span
                    ><span class="enlighter-m0">defined</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">STM32F103xG</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> &amp;&amp; !</span
                    ><span class="enlighter-m0">defined</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">STM32F105xC</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> &amp;&amp; !</span
                    ><span class="enlighter-m0">defined</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">STM32F107xC</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F100xB */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F100C4, STM32F100R4, STM32F100C6,
                      STM32F100R6, STM32F100C8, STM32F100R8, STM32F100V8,
                      STM32F100CB, STM32F100RB and STM32F100VB */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F100xE */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F100RC, STM32F100VC, STM32F100ZC,
                      STM32F100RD, STM32F100VD, STM32F100ZD, STM32F100RE,
                      STM32F100VE and STM32F100ZE */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F101x6 */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F101C4, STM32F101R4, STM32F101T4,
                      STM32F101C6, STM32F101R6 and STM32F101T6 Devices */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F101xB */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F101C8, STM32F101R8, STM32F101T8,
                      STM32F101V8, STM32F101CB, STM32F101RB, STM32F101TB and
                      STM32F101VB */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F101xE */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F101RC, STM32F101VC, STM32F101ZC,
                      STM32F101RD, STM32F101VD, STM32F101ZD, STM32F101RE,
                      STM32F101VE and STM32F101ZE */</span
                    ><span class="enlighter-text"> </span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F101xG */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F101RF, STM32F101VF, STM32F101ZF,
                      STM32F101RG, STM32F101VG and STM32F101ZG */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F102x6 */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F102C4, STM32F102R4, STM32F102C6 and
                      STM32F102R6 */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F102xB */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F102C8, STM32F102R8, STM32F102CB and
                      STM32F102RB */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F103x6 */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F103C4, STM32F103R4, STM32F103T4,
                      STM32F103C6, STM32F103R6 and STM32F103T6 */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="enlighter-special">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define STM32F103xB /*!&lt; STM32F103C8, STM32F103R8,
                      STM32F103T8, STM32F103V8, STM32F103CB, STM32F103RB,
                      STM32F103TB and STM32F103VB */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F103xE */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F103RC, STM32F103VC, STM32F103ZC,
                      STM32F103RD, STM32F103VD, STM32F103ZD, STM32F103RE,
                      STM32F103VE and STM32F103ZE */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F103xG */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F103RF, STM32F103VF, STM32F103ZF,
                      STM32F103RG, STM32F103VG and STM32F103ZG */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F105xC */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F105R8, STM32F105V8, STM32F105RB,
                      STM32F105VB, STM32F105RC and STM32F105VC */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* #define STM32F107xC */</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/*!&lt; STM32F107RB, STM32F107VB, STM32F107RC and
                      STM32F107VC */</span
                    ><span class="enlighter-text"> </span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4">#endif</span>
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                #if !defined (STM32F100xB) &amp;&amp; !defined (STM32F100xE)
                &amp;&amp; !defined (STM32F101x6) &amp;&amp; \ !defined
                (STM32F101xB) &amp;&amp; !defined (STM32F101xE) &amp;&amp;
                !defined (STM32F101xG) &amp;&amp; !defined (STM32F102x6)
                &amp;&amp; !defined (STM32F102xB) &amp;&amp; !defined
                (STM32F103x6) &amp;&amp; \ !defined (STM32F103xB) &amp;&amp;
                !defined (STM32F103xE) &amp;&amp; !defined (STM32F103xG)
                &amp;&amp; !defined (STM32F105xC) &amp;&amp; !defined
                (STM32F107xC) /* #define STM32F100xB */ /*!&lt; STM32F100C4,
                STM32F100R4, STM32F100C6, STM32F100R6, STM32F100C8, STM32F100R8,
                STM32F100V8, STM32F100CB, STM32F100RB and STM32F100VB */ /*
                #define STM32F100xE */ /*!&lt; STM32F100RC, STM32F100VC,
                STM32F100ZC, STM32F100RD, STM32F100VD, STM32F100ZD, STM32F100RE,
                STM32F100VE and STM32F100ZE */ /* #define STM32F101x6 */ /*!&lt;
                STM32F101C4, STM32F101R4, STM32F101T4, STM32F101C6, STM32F101R6
                and STM32F101T6 Devices */ /* #define STM32F101xB */ /*!&lt;
                STM32F101C8, STM32F101R8, STM32F101T8, STM32F101V8, STM32F101CB,
                STM32F101RB, STM32F101TB and STM32F101VB */ /* #define
                STM32F101xE */ /*!&lt; STM32F101RC, STM32F101VC, STM32F101ZC,
                STM32F101RD, STM32F101VD, STM32F101ZD, STM32F101RE, STM32F101VE
                and STM32F101ZE */ /* #define STM32F101xG */ /*!&lt;
                STM32F101RF, STM32F101VF, STM32F101ZF, STM32F101RG, STM32F101VG
                and STM32F101ZG */ /* #define STM32F102x6 */ /*!&lt;
                STM32F102C4, STM32F102R4, STM32F102C6 and STM32F102R6 */ /*
                #define STM32F102xB */ /*!&lt; STM32F102C8, STM32F102R8,
                STM32F102CB and STM32F102RB */ /* #define STM32F103x6 */ /*!&lt;
                STM32F103C4, STM32F103R4, STM32F103T4, STM32F103C6, STM32F103R6
                and STM32F103T6 */ #define STM32F103xB /*!&lt; STM32F103C8,
                STM32F103R8, STM32F103T8, STM32F103V8, STM32F103CB, STM32F103RB,
                STM32F103TB and STM32F103VB */ /* #define STM32F103xE */ /*!&lt;
                STM32F103RC, STM32F103VC, STM32F103ZC, STM32F103RD, STM32F103VD,
                STM32F103ZD, STM32F103RE, STM32F103VE and STM32F103ZE */ /*
                #define STM32F103xG */ /*!&lt; STM32F103RF, STM32F103VF,
                STM32F103ZF, STM32F103RG, STM32F103VG and STM32F103ZG */ /*
                #define STM32F105xC */ /*!&lt; STM32F105R8, STM32F105V8,
                STM32F105RB, STM32F105VB, STM32F105RC and STM32F105VC */ /*
                #define STM32F107xC */ /*!&lt; STM32F107RB, STM32F107VB,
                STM32F107RC and STM32F107VC */ #endif
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="c"
              data-enlighter-highlight="13"
              data-enlighter-title=""
            >
#if !defined (STM32F100xB) &amp;&amp; !defined (STM32F100xE) &amp;&amp; !defined (STM32F101x6) &amp;&amp; \
    !defined (STM32F101xB) &amp;&amp; !defined (STM32F101xE) &amp;&amp; !defined (STM32F101xG) &amp;&amp; !defined (STM32F102x6) &amp;&amp; !defined (STM32F102xB) &amp;&amp; !defined (STM32F103x6) &amp;&amp; \
    !defined (STM32F103xB) &amp;&amp; !defined (STM32F103xE) &amp;&amp; !defined (STM32F103xG) &amp;&amp; !defined (STM32F105xC) &amp;&amp; !defined (STM32F107xC)
  /* #define STM32F100xB  */   /*!&lt; STM32F100C4, STM32F100R4, STM32F100C6, STM32F100R6, STM32F100C8, STM32F100R8, STM32F100V8, STM32F100CB, STM32F100RB and STM32F100VB */
  /* #define STM32F100xE */    /*!&lt; STM32F100RC, STM32F100VC, STM32F100ZC, STM32F100RD, STM32F100VD, STM32F100ZD, STM32F100RE, STM32F100VE and STM32F100ZE */
  /* #define STM32F101x6  */   /*!&lt; STM32F101C4, STM32F101R4, STM32F101T4, STM32F101C6, STM32F101R6 and STM32F101T6 Devices */
  /* #define STM32F101xB  */   /*!&lt; STM32F101C8, STM32F101R8, STM32F101T8, STM32F101V8, STM32F101CB, STM32F101RB, STM32F101TB and STM32F101VB */
  /* #define STM32F101xE */    /*!&lt; STM32F101RC, STM32F101VC, STM32F101ZC, STM32F101RD, STM32F101VD, STM32F101ZD, STM32F101RE, STM32F101VE and STM32F101ZE */ 
  /* #define STM32F101xG  */   /*!&lt; STM32F101RF, STM32F101VF, STM32F101ZF, STM32F101RG, STM32F101VG and STM32F101ZG */
  /* #define STM32F102x6 */    /*!&lt; STM32F102C4, STM32F102R4, STM32F102C6 and STM32F102R6 */
  /* #define STM32F102xB  */   /*!&lt; STM32F102C8, STM32F102R8, STM32F102CB and STM32F102RB */
  /* #define STM32F103x6  */   /*!&lt; STM32F103C4, STM32F103R4, STM32F103T4, STM32F103C6, STM32F103R6 and STM32F103T6 */
#define STM32F103xB     /*!&lt; STM32F103C8, STM32F103R8, STM32F103T8, STM32F103V8, STM32F103CB, STM32F103RB, STM32F103TB and STM32F103VB */
  /* #define STM32F103xE */    /*!&lt; STM32F103RC, STM32F103VC, STM32F103ZC, STM32F103RD, STM32F103VD, STM32F103ZD, STM32F103RE, STM32F103VE and STM32F103ZE */
  /* #define STM32F103xG  */   /*!&lt; STM32F103RF, STM32F103VF, STM32F103ZF, STM32F103RG, STM32F103VG and STM32F103ZG */
  /* #define STM32F105xC */    /*!&lt; STM32F105R8, STM32F105V8, STM32F105RB, STM32F105VB, STM32F105RC and STM32F105VC */
  /* #define STM32F107xC  */   /*!&lt; STM32F107RB, STM32F107VB, STM32F107RC and STM32F107VC */  
#endif</pre
            >
            <br />
            Далее пишем следующий main:<br />
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-k4">#include "stm32f1xx.h"</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"></span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k5">int</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-m0">main</span
                    ><span class="enlighter-g1">()</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-g1">{</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k0">return</span
                    ><span class="enlighter-text"> 0;</span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-g1">}</span>
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                #include "stm32f1xx.h" int main() { return 0; }
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="c"
              data-enlighter-title=""
            >
#include "stm32f1xx.h"

int main()
{
  return 0;
}
</pre
            >
            <br />
            Выбираем <em>Project-&gt;Make</em>. Если все сделали правильно, то
            получаем сообщение об успешной компиляции проекта:
            <p></p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-534 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-47-36.png"
                alt=""
                width="765"
                height="541"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-47-36.png         765w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-47-36-300x212.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-47-36-212x150.png 212w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2018-08-04_21-47-36-150x106.png 150w
                "
                sizes="(max-width: 765px) 100vw, 765px"
              />
            </p>
          </div>
        </div>
        <div class="accordion-item">
          <div class="accordion-header">Часть 3: Система тактирования</div>
          <div class="accordion-content">
            <p>
              Система тактирования в STM32 в сравнении с микроконтроллерами AVR
              выполнена довольно замысловато. Давайте разбираться.
            </p>
            <h2>Содержание:</h2>
            <ul>
              <li>Шины</li>
              <li>Генераторы</li>
              <li>Тактирование периферии</li>
              <li>Источники сигнала SYSCLK</li>
              <li>HSE и PLL</li>
              <li>Что еще?</li>
              <li>Заключение</li>
            </ul>
            <h2>Шины</h2>
            <p>
              У микроконтроллеров STM32 все периферийные устройства&nbsp;(порты
              ввода-вывода, таймеры, интерфейсы SPI, и т.д.) подключены к так
              называемым <strong>шинам</strong>, через которые
              <strong>периферия </strong>получает
              <strong>тактовый сигнал</strong> и
              <strong>обменивается данными</strong> с ведущими устройствами шины
              (например, с процессором).
            </p>
            <p>
              В STM32F103x8 три основных шины: <em>AHB, APB1 и APB2</em>. На
              каждой из шин висит определенная группа устройств:
            </p>
            <ul>
              <li><em>AHB:</em> процессорное ядро, память и DMA;</li>
              <li>
                <em>APB1:</em> USART2,&nbsp;USART3, I2C1/2, CAN, таймеры
                TIM2..4;
              </li>
              <li><em>APB2:</em> порты GPIO, АЦП, USART1, TIM1, SPI1.</li>
            </ul>
            <p>
              В даташите на&nbsp;STM32F103x8 есть блок-схема, в которой указано,
              какая периферия куда подключена:
            </p>
            <p style="text-align: center">
              <a
                href="http://dimoon.ru/wp-content/uploads/2018/08/1.png"
                target="_blank"
                rel="noopener"
                ><img
                  loading="lazy"
                  class="aligncenter wp-image-548 size-large imageNone"
                  src="http://dimoon.ru/wp-content/uploads/2018/08/1-844x1024.png"
                  alt=""
                  width="830"
                  height="1007"
                  srcset="
                    http://dimoon.ru/wp-content/uploads/2018/08/1-844x1024.png  844w,
                    http://dimoon.ru/wp-content/uploads/2018/08/1-247x300.png   247w,
                    http://dimoon.ru/wp-content/uploads/2018/08/1-768x932.png   768w,
                    http://dimoon.ru/wp-content/uploads/2018/08/1-124x150.png   124w,
                    http://dimoon.ru/wp-content/uploads/2018/08/1.png          1187w
                  "
                  sizes="(max-width: 830px) 100vw, 830px" /></a
              ><em
                >Рис. 1. Блок-схема микроконтроллеров&nbsp;STM32F103x8
                и&nbsp;STM32F103xB</em
              >
            </p>
            <p>
              Схема на <em>рис. 1</em> поначалу может казаться сложной и
              непонятной, это нормально, со временем все в голове уложится и
              ощущение непонимания исчезнет.
            </p>
            <p>
              А еще есть вот такая таблица, в которой так же указаны
              периферийные устройства и шины, к которым они подключены:
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-549 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/2.png"
                alt=""
                width="711"
                height="967"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/2.png         711w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2-221x300.png 221w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2-110x150.png 110w
                "
                sizes="(max-width: 711px) 100vw, 711px"
              />
            </p>
            <p style="text-align: center">
              <em>Рис. 2. Таблица шин и периферийных устройств</em>
            </p>
            <p>
              Можно заметить, что на <em>рис. 2&nbsp;</em>возле названия шины
              (<em>AHB</em>, <em>APB1</em> и <em>APB2</em>) в скобках указана ее
              максимальная частота. Так как периферийные устройства получают
              тактовый сигнал от шины, ее частота задает скорость работы
              подключенных к данной шине устройств. Далее мы рассмотрим, как
              настроить частоту каждой из шин микроконтроллера.
            </p>
            <p>
              Еще одной особенностью системы тактирования STM32 является то, что
              после сигнала сброса микроконтроллера вся периферия находится в
              отключенном состоянии и на нее не подается тактовый сигнал. Это
              сделано с целью снижения энергопотребления всего микроконтроллера.
              Перед началом работы с любым периферийным устройством необходимо
              разрешить подачу на него тактового сигнала. Как это сделать
              рассмотрим далее.
            </p>
            <p>Итак, вот основные тезисы, которые необходимо запомнить:</p>
            <ol>
              <li>
                Все периферийные устройства в микроконтроллерах STM32 подключены
                к шинам (<em>AHB, APB1 </em>и<em> APB2</em>), через которые
                производится взаимодействие с устройствами и подача на них
                тактовых сигналов;
              </li>
              <li>
                Шины микроконтроллера STM32 могут иметь разные частоты
                тактирования;
              </li>
              <li>
                Перед началом работы с периферийным устройством необходимо
                разрешить подачу на него тактового сигнала.
              </li>
            </ol>
            <h2>Генераторы</h2>
            <p>
              В микроконтроллерах&nbsp;STM32F103x8/B присутствует несколько
              генераторов тактового сигнала:
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-550 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/3.png"
                alt=""
                width="753"
                height="835"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/3.png         753w,
                  http://dimoon.ru/wp-content/uploads/2018/08/3-271x300.png 271w,
                  http://dimoon.ru/wp-content/uploads/2018/08/3-135x150.png 135w
                "
                sizes="(max-width: 753px) 100vw, 753px"
              />
            </p>
            <p style="text-align: center">
              <em
                >Рис. 3. Блок-схема системы тактирования, красными
                прямоугольниками выделены генераторы тактовых сигналов</em
              >
            </p>
            <p>
              Первый из них — встроенный RC-генератор на 8 МГц, который
              называется
              <strong>High-speed internal&nbsp;(HSI) RC oscillator</strong>.
              После сброса микроконтроллер по-умолчанию тактируется как раз от
              этого генератора. Основным его плюсом является то, что для работы
              генератора не нужны ни какие дополнительные внешние компоненты.
              Однако его минус — плохая стабильность генерируемой частоты: при
              изменении температуры окружающей среды его частота в&nbsp;8 МГц
              будет немного плыть. Для нетребовательных ко временнЫм интервалам
              устройств это может быть не критично, но в некоторых случаях
              данная особенность является недопустимой.
            </p>
            <p>
              Следующий —&nbsp;<strong>High-speed external (HSE)</strong>. Этот
              генератор является альтернативой&nbsp;HSI. Для его работы нужен
              внешний кварцевый резонатор на частоту 4-16 МГц. Его главным
              преимуществом в сравнении с&nbsp;HSI является стабильность
              генерируемой частоты. Так же, при определенной настройке, вывод
              OSC_IN можно подключить к источнику готового прямоугольного
              тактового сигнала без использования резонатора.
            </p>
            <p>
              Далее&nbsp;<strong>Low-speed external (LSE)</strong>. Этот
              генератор так же требует внешнего кварцевого резонатора, но только
              на 32768 Гц.&nbsp;LSE используется только для тактирования
              встроенных часов реального времени RTC, с помощью которых можно
              вести отсчет текущего времени, если это нужно.
            </p>
            <p>
              Последний генератор — это&nbsp;<strong
                >Low-speed internal (LSI) RC oscillator</strong
              >. Это встроенный RC-генератор на 40 КГц. Он не отличается особой
              точностью, однако у него есть очень важная задача: генерация
              тактового сигнала для сторожевого таймера МК, который перезапустит
              систему в случае зависания. А еще от&nbsp;LSI можно тактировать
              RTC, но скорее всего это ни кто делать не будет
            </p>
            <h2>Тактирование периферии</h2>
            <p>
              Процессорное ядро и основная часть периферии использует тактовый
              сигнал <em>SYSCLK</em>.
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-562 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/4_1.png"
                alt=""
                width="520"
                height="504"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/4_1.png         520w,
                  http://dimoon.ru/wp-content/uploads/2018/08/4_1-300x291.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/4_1-155x150.png 155w,
                  http://dimoon.ru/wp-content/uploads/2018/08/4_1-150x145.png 150w
                "
                sizes="(max-width: 520px) 100vw, 520px"
              />
            </p>
            <p style="text-align: center">
              <em>Рис. 4. Распределение тактового сигнала SYSCLK</em>
            </p>
            <p>
              После делителя&nbsp;<em>AHB Prescaler&nbsp;</em>тактовый сигнал
              распределяется между шинами микроконтроллера.
              Сигнал&nbsp;<em>HCLK</em>&nbsp;поступает в процессорное ядро,
              память и периферию шины <em><strong>AHB</strong></em
              >.&nbsp;<em>FCLK </em>так же идет в ядро<em>.</em>&nbsp;Через
              фиксированный делитель на 8 тактирование подается на системный
              таймер <em>Cortex System timer</em>. Делитель
              <em>APB1&nbsp;Prescaler&nbsp;</em>формирует сигнал тактирования
              устройств шины&nbsp;<em><strong>APB1</strong></em
              >, а&nbsp;<em>APB2&nbsp;Prescaler&nbsp;</em>для устройств&nbsp;<em
                ><strong>APB2</strong>.&nbsp;</em
              >
            </p>
            <p>
              Тут правда есть небольшая особенность формирования тактового
              сигнала для таймеров и АЦП.
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-554 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/5.png"
                alt=""
                width="417"
                height="228"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/5.png         417w,
                  http://dimoon.ru/wp-content/uploads/2018/08/5-300x164.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/5-250x137.png 250w,
                  http://dimoon.ru/wp-content/uploads/2018/08/5-150x82.png  150w
                "
                sizes="(max-width: 417px) 100vw, 417px"
              />
            </p>
            <p style="text-align: center">
              <em
                >Рис. 5. Распределение тактового сигнала шины APB1 между
                устройствами&nbsp;</em
              >
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-555 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/6.png"
                alt=""
                width="437"
                height="302"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/6.png         437w,
                  http://dimoon.ru/wp-content/uploads/2018/08/6-300x207.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/6-217x150.png 217w,
                  http://dimoon.ru/wp-content/uploads/2018/08/6-150x104.png 150w
                "
                sizes="(max-width: 437px) 100vw, 437px"
              />
            </p>
            <p style="text-align: center">
              <em
                >Рис. 6. Распределение тактового сигнала шины APB2 между
                устройствами&nbsp;</em
              >
            </p>
            <p>
              Тактовый сигнал на таймеры подается следующим образом. Если
              делитель шины (<em>APB1&nbsp;Prescaler </em
              >или&nbsp;<em>APB2&nbsp;Prescaler</em>) установлен в единицу, то
              частота тактирования тактирования таймеров (<em>TIMXCLK</em>
              или&nbsp;<em>TIM1CLK)</em> будет равна частоте шины. Но, если
              делитель не равен единице, то частота тактирования таймеров будет
              в 2 раза больше частоты шины (см. рис. 5, 6). А для АЦП есть свой
              собственный делитель, который из частоты тактирования шины
              <em>APB2</em> формирует сигнал <em>ADCCLK</em>&nbsp;(рис. 6).
            </p>
            <p>
              Думаю, следует еще обратить внимание на вот эти элементы
              блок-схемы:
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-563 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/7-1.png"
                alt=""
                width="556"
                height="636"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/7-1.png         556w,
                  http://dimoon.ru/wp-content/uploads/2018/08/7-1-262x300.png 262w,
                  http://dimoon.ru/wp-content/uploads/2018/08/7-1-131x150.png 131w
                "
                sizes="(max-width: 556px) 100vw, 556px"
              />
            </p>
            <p style="text-align: center"><em>Рис. 7</em></p>
            <p>
              Это есть ни что иное, как устройства подачи тактового сигнала на
              конкретную периферию (логические элементы 2И). Попробую
              перерисовать один из них так, чтоб было понятнее, что это и как
              оно работает:
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-564 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/8.png"
                alt=""
                width="447"
                height="395"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/8.png         447w,
                  http://dimoon.ru/wp-content/uploads/2018/08/8-300x265.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/8-170x150.png 170w,
                  http://dimoon.ru/wp-content/uploads/2018/08/8-150x133.png 150w
                "
                sizes="(max-width: 447px) 100vw, 447px"
              />
            </p>
            <p style="text-align: center"><em>Рис. 8.&nbsp;</em></p>
            <p>
              У каждого периферийного модуля в специальном регистре есть свой
              бит (<em>SPI1EN, IOPAEN, IOABEN</em> и так далее), при установке
              которого в единицу разрешается подача на него тактового сигнала.
              На рис. 8 я привел пример только для тактового сигнала
              <em>PCLK2</em> шины <em>APB2</em>, для остальных сигналов (<em
                >HCLK, PCLK1, TIMXCLK, TIM1CLK</em
              >) все то же самое.
            </p>
            <h2>Источники сигнала SYSCLK</h2>
            <p>
              Итак, теперь мы знаем, что основным тактовым сигналом в
              микроконтроллерах STM32 является <em>SYSCLK</em>. Давайте теперь
              разберемся, как его получить. В нашем распоряжении 3 варианта:
              генераторы <em>HSI</em>, <em>HSE</em> и модуль <em>PLL</em>:
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-565 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/9.png"
                alt=""
                width="214"
                height="194"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/9.png         214w,
                  http://dimoon.ru/wp-content/uploads/2018/08/9-165x150.png 165w,
                  http://dimoon.ru/wp-content/uploads/2018/08/9-150x136.png 150w
                "
                sizes="(max-width: 214px) 100vw, 214px"
              />
            </p>
            <p style="text-align: center">
              <em>Рис. 9. Источники сигнала SYSCLK</em>
            </p>
            <p>
              После сброса микроконтроллера в качестве источника сигнала
              <em>SYSCLK</em> по-умолчанию устанавливается встроенный
              RC-генератор <em>HSI</em>. Прохождение тактового сигнала для этого
              случая представлено на рис. 10, значения по-умолчанию&nbsp;всех
              делителей обвел кружочком:
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-560 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/7.png"
                alt=""
                width="746"
                height="717"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/7.png         746w,
                  http://dimoon.ru/wp-content/uploads/2018/08/7-300x288.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/7-156x150.png 156w,
                  http://dimoon.ru/wp-content/uploads/2018/08/7-150x144.png 150w
                "
                sizes="(max-width: 746px) 100vw, 746px"
              />
            </p>
            <p style="text-align: center">
              <em>Рис. 10. Конфигурация системы тактирования по-умолчанию</em>
            </p>
            <p>
              А теперь давайте посчитаем значения всех частот в конфигурации
              по-умолчанию. Частоты
              <em>HCLK, FCLK, PCLK1, TIMXCLK,&nbsp;PCLK2, TIM1CLK</em> будут
              равны 8 МГц, частота <em>Cortex System timer</em>&nbsp;равна 1
              МГц, а <em>ADCCLK</em> 4 Мгц.
            </p>
            <p>
              Если мы хотим задействовать HSE-генератор, то картина будет
              следующей:
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-569 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/11-1.png"
                alt=""
                width="700"
                height="670"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/11-1.png         700w,
                  http://dimoon.ru/wp-content/uploads/2018/08/11-1-300x287.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/11-1-157x150.png 157w,
                  http://dimoon.ru/wp-content/uploads/2018/08/11-1-150x144.png 150w
                "
                sizes="(max-width: 700px) 100vw, 700px"
              />
            </p>
            <p style="text-align: center">
              <em
                >Рис. 11. Выбор генератора HSE в качестве источника тактирования
                SYSCLK</em
              >
            </p>
            <p>
              При использовании кварцевого резонатора на 8 МГц все системные
              частоты будут такими же, что и в предыдущем случае. Разница только
              в одном: при использовании генератора <em>HSE</em> стабильность
              частот лучше, чем при использовании&nbsp;HSI. Однако, если мы
              хотим получить максимальную производительность всей системы, то
              нужно в качестве источника <em>SYSCLK</em> использовать блок
              умножения частоты <em>PLL</em>.
            </p>
            <h2>HSE и PLL</h2>
            <p>
              В микроконтроллерах STM32 модуль <em>PLL</em> может тактироваться
              как от <em>HSI</em> генератора, так и от
              <em>HSE</em>.&nbsp;Существует огромное количество вариантов
              настройки тактирования системы от <em>PLL</em>. Мы остановимся
              только на одном, в котором используется&nbsp;<em>HSE</em> и все
              коэффициенты настроены на максимальную производительность системы:
            </p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-570 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/12.png"
                alt=""
                width="699"
                height="669"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/12.png         699w,
                  http://dimoon.ru/wp-content/uploads/2018/08/12-300x287.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/12-157x150.png 157w,
                  http://dimoon.ru/wp-content/uploads/2018/08/12-150x144.png 150w
                "
                sizes="(max-width: 699px) 100vw, 699px"
              />
            </p>
            <p style="text-align: center">
              <em
                >Рис. 12. Схема прохождения тактового сигнала при использовании
                PLL совместно с HSE</em
              >
            </p>
            <p>
              Кварцевый резонатор выбираем на 8 МГц. Далее, сигнал с
              <em>HSE</em> без деления (настраивается битом <em>PLLXTPRE</em>)
              поступает на селектор <em>PLLSRC</em> и потом на <em>PLL</em>. Для
              того, чтобы из 8-и МГц получить 72 МГц, коэффициент умножения
              <em>PLL</em> должен быть равен <em>PLLMUL</em>=9. Далее, сигнал с
              <em>PLL</em> частотой 72 МГц через селектор <em>SW</em> поступает
              на <em>SYSCLK</em>. Так как процессорное ядро мы хотим тактировать
              максимальной частотой в 72 МГц,
              <em>AHB Prescaler</em> устанавливаем равный единице (без деления).
              Для получения частоты шины <em>APB1</em>, равной 36 МГц,
              <em>APB1&nbsp;Prescaler</em> ставим равным 2. Шина
              <em>APB2</em> имеет максимальную частоту 72 МГц,
              следовательно,&nbsp;<em>APB2 Prescaler</em> можно установить в 1.
            </p>
            <p>Итого:</p>
            <ul>
              <li>Кварц HSE на 8 МГц</li>
              <li>PLLXTPRE: без деления</li>
              <li>PLLSRC: HSE генератор</li>
              <li>PLLMUL = 9</li>
              <li>SW = PLLCLK</li>
              <li>AHB Prescaler = 1</li>
              <li>APB1&nbsp;Prescaler = 2</li>
              <li>APB2 Prescaler = 1</li>
            </ul>
            <h2>Что еще?</h2>
            <p>
              Здесь мы не рассмотрели еще некоторые блоки системы тактирования,
              о которых хочется упомянуть.
            </p>
            <p>
              <em>Clock security system (CSS)</em> — переводится примерно как
              «система безопасности тактирования». Если, при использовании
              генератора HSE в качестве источника тактового сигнала для SYSCLK
              или PLL, произойдет срыв генерации&nbsp;HSE, то CSS автоматически
              переключит всю систему на работу от встроенного RC-генератора HSI.
              Таким образом, если что-то случится с кварцем, система не зависнет
              намертво в неопределенном состоянии, а сможет выполнить какие-то
              действия, например, перевести объект управления в безопасное
              состояние (закрыть все вентили, отключить силовые установки, и
              т.д.)
            </p>
            <p>
              Модуль часов реального времени <em>RTC</em> может тактироваться от
              встроенного <em>LSI</em> генератора на 40 КГц, от
              <em>HSE</em> через делитель на 128, либо от <em>LSE</em> с внешним
              кварцем на 32768 Гц. Источник тактовых импульсов выбирается с
              помощью <em>RTCSEL</em>.
            </p>
            <p>
              Модуль USB получает тактовый сигнал от <em>PLL</em>, причем при
              частоте на выходе <em>PLL</em> равной 72 МГц есть возможность
              активировать U<em>SB Prescaler</em> с коэффициентом деления 1.5
              для получения необходимой частоты 48 МГц.
            </p>
            <p>
              <em>Microcontroller clock output (MCO)</em> — вывод
              микроконтроллера, на который можно вывести частоту от одного из
              источников сигнала: <em>SYSCLK, HSE, HSI</em> либо сигнал с выхода
              <em>PLL</em>, поделенный пополам. Нужный источник выбирается с
              помощью битов <em>MCO</em>.
            </p>
            <h2>Заключение</h2>
            <p>
              Итак, мы рассмотрели основные моменты в системе тактирования
              микроконтроллеров STM32 на примере STM32F103x8 и&nbsp;STM32F103xB.
              В других микроконтроллерах STM32 примерно все то же самое, за
              исключением некоторых нюансов. В следующей части мы познакомимся с
              регистрами системы тактирования и сброса <em>RCC</em> и рассмотрим
              пример инициализации <em>RCC</em>.
            </p>
          </div>
        </div>
        <div class="accordion-item">
          <div class="accordion-header">Настройка RCC</div>
          <div class="accordion-content">
            <h2>Регистры&nbsp;CR и&nbsp;CFGR</h2>
            <p>
              Открываем&nbsp;Reference manual на микроконтроллер STM32F103x8 и
              переходим к разделу&nbsp;7:
              <em
                >Low-, medium-, high- and XL-density reset and clock control
                (RCC).&nbsp;RCC</em
              >
              имеет довольно много регистров, целых 10 штук. Однако, для
              настройки источника тактирования и делителей шин нам понадобится
              только 2 из них.
            </p>
            <p><strong>Clock control register (RCC_CR)</strong></p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-583 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/1-1.png"
                alt=""
                width="807"
                height="172"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/1-1.png         807w,
                  http://dimoon.ru/wp-content/uploads/2018/08/1-1-300x64.png  300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/1-1-768x164.png 768w,
                  http://dimoon.ru/wp-content/uploads/2018/08/1-1-250x53.png  250w,
                  http://dimoon.ru/wp-content/uploads/2018/08/1-1-150x32.png  150w,
                  http://dimoon.ru/wp-content/uploads/2018/08/1-1-800x172.png 800w
                "
                sizes="(max-width: 807px) 100vw, 807px"
              />
            </p>
            <p style="text-align: center">
              <em>Рис. 1. Биты регистра&nbsp;CR</em>
            </p>
            <p>Описание основных битов регистра:</p>
            <p>
              <strong>PLLRDY</strong> — флаг готовности PLL. Устанавливается
              аппаратно и сигнализирует о том, что PLL заблокирован.
            </p>
            <p>
              <strong>PLLON</strong> — Включить PLL. Устанавливается и
              сбрасывается программно. При переходе в режим&nbsp;Stop
              или&nbsp;Standby сбрасывается аппаратно. Этот бит не может быть
              сброшен, если PLL используется как источник системного
              тактирования.
            </p>
            <p><strong>CSSON</strong> — включить систему CSS</p>
            <p>
              <strong>HSEBYP</strong> — Если вместо кварцевого резонатора
              HSE&nbsp;мы хотим использовать внешний прямоугольный тактовый
              сигнал, то этот бит нужно установить в 1
            </p>
            <p>
              <strong>HSERDY</strong> — Флаг готовности генератора&nbsp;HSE.
              Аппаратно устанавливается в 1 после успешного запуска и
              стабилизации частоты&nbsp;HSE-генератора
            </p>
            <p>
              <strong>HSEON</strong> — Запустить&nbsp;HSE генератор.
              Устанавливается и сбрасывается программно.&nbsp;При переходе в
              режим&nbsp;Stop или&nbsp;Standby сбрасывается аппаратно и HSE
              генератор останавливается.&nbsp;&nbsp;Этот бит не может быть
              сброшен, если HSE используется как источник системного
              тактирования.
            </p>
            <p>
              <strong>HSIRDY</strong> — то же самое, что и&nbsp;HSERDY, только
              для встроенного RC-генератора HSI
            </p>
            <p>
              <strong>HSION</strong> —&nbsp;то же самое, что и HSEON, только для
              встроенного RC-генератора HSI
            </p>
            <p>&nbsp;</p>
            <p><strong>Clock configuration register (RCC_CFGR)</strong></p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-584 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/2-1.png"
                alt=""
                width="803"
                height="169"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/2-1.png         803w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2-1-300x63.png  300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2-1-768x162.png 768w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2-1-250x53.png  250w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2-1-150x32.png  150w,
                  http://dimoon.ru/wp-content/uploads/2018/08/2-1-800x169.png 800w
                "
                sizes="(max-width: 803px) 100vw, 803px"
              />
            </p>
            <p style="text-align: center">
              <em>Рис. 2. Биты регистра CFGR</em>
            </p>
            <p>Описание основных битов регистра:</p>
            <p>
              <strong>MCO</strong> — подача тактового сигнала
              на&nbsp;MCO-пин&nbsp;микроконтроллера.
            </p>
            <ul>
              <li>0xx: Функция отключена</li>
              <li>100: Выбран System clock (SYSCLK)</li>
              <li>101: Выбран сигнал с HSI</li>
              <li>110: Выбран сигнал с HSE</li>
              <li>111: Выбран сигнал с PLL, который поделен на 2</li>
            </ul>
            <p>
              <strong>PLLMUL</strong> — коэффициент умножения PLL. Эти биты
              могут быть записаны программно только при отключенном PLL
            </p>
            <ul>
              <li>0000: Входную частота PLL умножить на 2</li>
              <li>0001: —//— на 3</li>
              <li>0010: —//— на 4</li>
              <li>0011: —//— на&nbsp;5</li>
              <li>0100: —//— на 6</li>
              <li>0101: —//— на 7</li>
              <li>0110: —//— на 8</li>
              <li>0111: —//— на 9</li>
              <li>1000: —//— на 10</li>
              <li>1001:&nbsp;—//— на 11</li>
              <li>1010: —//— на 12</li>
              <li>1011: —//— на 13</li>
              <li>1100: —//— на 14</li>
              <li>1101: —//— на 15</li>
              <li>1110: —//— на 16</li>
              <li>1111: —//— на 16</li>
            </ul>
            <p>
              Два последних значения соответствуют одинаковому коэффициенту
              умножения.
            </p>
            <p>
              <strong>PLLXTPRE</strong> — Делитель частоты с HSE генератора
              перед подачей на PLL. Этот бит не может быть изменен, если PLL
              запущен. При установке в 1 частота HSE будет поделена на 2, если
              0, то делитель отключен.
            </p>
            <p>
              <strong>PLLSRC</strong> — Источник входной частоты PLL. Не может
              быть изменен,&nbsp;если PLL запущен.
            </p>
            <ul>
              <li>0: частота HSI генератора поделенная на 2</li>
              <li>
                1: частота HSE генератора. Делитель может быть
                выбран&nbsp;PLLXTPRE битом.
              </li>
            </ul>
            <p>
              <strong>PPRE2</strong> — Делитель шины&nbsp;<em
                >APB2&nbsp;prescaler</em
              >
            </p>
            <ul>
              <li>0xx: HCLK без деления</li>
              <li>100: HCLK / 2</li>
              <li>101: HCLK / 4</li>
              <li>110: HCLK / 8</li>
              <li>111: HCLK / 16</li>
            </ul>
            <p>
              <strong>PPRE1</strong> — Делитель шины&nbsp;<em
                >APB1&nbsp;prescaler. </em
              >Частота шины&nbsp;APB1 не должна превышать 36 МГц.
            </p>
            <ul>
              <li>0xx: HCLK без деления</li>
              <li>100: HCLK / 2</li>
              <li>101: HCLK / 4</li>
              <li>110: HCLK / 8</li>
              <li>111: HCLK / 16</li>
            </ul>
            <p><strong>HPRE</strong> —&nbsp;AHB prescaler</p>
            <ul>
              <li>0xxx: SYSCLK без деления</li>
              <li>1000: SYSCLK / 2</li>
              <li>1001: SYSCLK / 4</li>
              <li>1010: SYSCLK / 8</li>
              <li>1011: SYSCLK / 16</li>
              <li>1100: SYSCLK / 64</li>
              <li>1101: SYSCLK / 128</li>
              <li>1110: SYSCLK / 256</li>
              <li>1111: SYSCLK / 512</li>
            </ul>
            <p>
              <strong>SWS</strong> —&nbsp;Состояние переключателя тактирования
              системы. Устанавливается аппаратно и указывает на текущий источник
              тактирования.
            </p>
            <ul>
              <li>
                00: HSI генератор используется как источник тактирования системы
              </li>
              <li>
                01: HSE генератор используется как источник тактирования системы
              </li>
              <li>
                10: PLL&nbsp;используется как источник тактирования системы
              </li>
            </ul>
            <p>
              <strong>SW</strong> — Переключатель источника тактирования
              системы. Изменяется программно для выбора источника&nbsp;SYSCLK.
              Устанавливается аппаратно для принудительного переключения
              на&nbsp;HSI генератор переходе в режим&nbsp;Stop или&nbsp;Standby
              или в случае срыва генерации&nbsp;HSE, который используется в
              качестве источника&nbsp;SYSCLK (только если активна система CSS)
            </p>
            <ul>
              <li>
                00: HSI выбран в качестве источника системного тактирования
              </li>
              <li>
                01: HSE выбран в качестве источника системного тактирования
              </li>
              <li>
                10: PLL выбран в качестве источника системного тактирования
              </li>
            </ul>
            <p><a name="koefficienty"></a></p>
            <h2>Коэффициенты</h2>
            <p>
              <a
                href="http://dimoon.ru/obuchalka/stm32f1/uroki-stm32f103-chast-3-sistema-taktirovaniya.html"
                >В предыдущей части</a
              >
              мы рассмотрели вариант тактирования системы тактирования от
              <em>HSE</em> генератора через <em>PLL</em>, для удобства скопирую
              это сюда:
            </p>
            <ul>
              <li>Кварц HSE на 8 МГц</li>
              <li>PLLXTPRE: без деления</li>
              <li>PLLSRC: HSE генератор</li>
              <li>PLLMUL = 9</li>
              <li>SW = PLLCLK</li>
              <li>AHB Prescaler = 1</li>
              <li>APB1&nbsp;Prescaler = 2</li>
              <li>APB2 Prescaler = 1</li>
            </ul>
            <p>И картинку тоже:</p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-587 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/3-1.png"
                alt=""
                width="699"
                height="669"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/3-1.png         699w,
                  http://dimoon.ru/wp-content/uploads/2018/08/3-1-300x287.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/3-1-157x150.png 157w,
                  http://dimoon.ru/wp-content/uploads/2018/08/3-1-150x144.png 150w
                "
                sizes="(max-width: 699px) 100vw, 699px"
              />
            </p>
            <p style="text-align: center">
              <em
                >Рис. 3. Схема прохождения тактового сигнала при использовании
                PLL совместно с HSE</em
              >
            </p>
            <p><a name="registry_cmsis"></a></p>
            <h2>Регистры в CMSIS</h2>
            <p>
              Во
              <a
                href="http://dimoon.ru/obuchalka/stm32f1/uroki-stm32f103-chast-2-iar-cmsis.html"
                >второй части</a
              >
              мы учились подключать библиотеку <em>CMSIS</em> к IAR-у, сейчас
              нам понадобится этот проект, так как мы переходим к практике. Но
              перед этим немного поговорим о том, как устроено обращение к
              регистрам периферии в CMSIS.
            </p>
            <p>
              Каждый экземпляр периферии является структурой, в которой
              находятся все регистры, относящиеся к данному устройству. Почти во
              всех случаях имя структуры совпадает с именем периферийного
              модуля. Для микроконтроллера STM32F103C8 все структуры
              периферийных модулей объявлены в файле&nbsp;<em>stm32f103xb.h:</em
              ><br />
            </p>
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-k4"
                      >#define TIM2 ((TIM_TypeDef *)TIM2_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define TIM3 ((TIM_TypeDef *)TIM3_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define TIM4 ((TIM_TypeDef *)TIM4_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define RTC ((RTC_TypeDef *)RTC_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define WWDG ((WWDG_TypeDef *)WWDG_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define IWDG ((IWDG_TypeDef *)IWDG_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define SPI2 ((SPI_TypeDef *)SPI2_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define USART2 ((USART_TypeDef *)USART2_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define USART3 ((USART_TypeDef *)USART3_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define I2C1 ((I2C_TypeDef *)I2C1_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define I2C2 ((I2C_TypeDef *)I2C2_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define USB ((USB_TypeDef *)USB_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define CAN1 ((CAN_TypeDef *)CAN1_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define BKP ((BKP_TypeDef *)BKP_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define PWR ((PWR_TypeDef *)PWR_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define AFIO ((AFIO_TypeDef *)AFIO_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define EXTI ((EXTI_TypeDef *)EXTI_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define GPIOA ((GPIO_TypeDef *)GPIOA_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define GPIOB ((GPIO_TypeDef *)GPIOB_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define GPIOC ((GPIO_TypeDef *)GPIOC_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define GPIOD ((GPIO_TypeDef *)GPIOD_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define GPIOE ((GPIO_TypeDef *)GPIOE_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define ADC1 ((ADC_TypeDef *)ADC1_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define ADC2 ((ADC_TypeDef *)ADC2_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define ADC12_COMMON ((ADC_Common_TypeDef
                      *)ADC1_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define TIM1 ((TIM_TypeDef *)TIM1_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define SPI1 ((SPI_TypeDef *)SPI1_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define USART1 ((USART_TypeDef *)USART1_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define SDIO ((SDIO_TypeDef *)SDIO_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define DMA1 ((DMA_TypeDef *)DMA1_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define DMA1_Channel1 ((DMA_Channel_TypeDef
                      *)DMA1_Channel1_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define DMA1_Channel2 ((DMA_Channel_TypeDef
                      *)DMA1_Channel2_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define DMA1_Channel3 ((DMA_Channel_TypeDef
                      *)DMA1_Channel3_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define DMA1_Channel4 ((DMA_Channel_TypeDef
                      *)DMA1_Channel4_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define DMA1_Channel5 ((DMA_Channel_TypeDef
                      *)DMA1_Channel5_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define DMA1_Channel6 ((DMA_Channel_TypeDef
                      *)DMA1_Channel6_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define DMA1_Channel7 ((DMA_Channel_TypeDef
                      *)DMA1_Channel7_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define RCC ((RCC_TypeDef *)RCC_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define CRC ((CRC_TypeDef *)CRC_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define FLASH ((FLASH_TypeDef *)FLASH_R_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define OB ((OB_TypeDef *)OB_BASE)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k4"
                      >#define DBGMCU ((DBGMCU_TypeDef *)DBGMCU_BASE)</span
                    >
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                #define TIM2 ((TIM_TypeDef *)TIM2_BASE) #define TIM3
                ((TIM_TypeDef *)TIM3_BASE) #define TIM4 ((TIM_TypeDef
                *)TIM4_BASE) #define RTC ((RTC_TypeDef *)RTC_BASE) #define WWDG
                ((WWDG_TypeDef *)WWDG_BASE) #define IWDG ((IWDG_TypeDef
                *)IWDG_BASE) #define SPI2 ((SPI_TypeDef *)SPI2_BASE) #define
                USART2 ((USART_TypeDef *)USART2_BASE) #define USART3
                ((USART_TypeDef *)USART3_BASE) #define I2C1 ((I2C_TypeDef
                *)I2C1_BASE) #define I2C2 ((I2C_TypeDef *)I2C2_BASE) #define USB
                ((USB_TypeDef *)USB_BASE) #define CAN1 ((CAN_TypeDef
                *)CAN1_BASE) #define BKP ((BKP_TypeDef *)BKP_BASE) #define PWR
                ((PWR_TypeDef *)PWR_BASE) #define AFIO ((AFIO_TypeDef
                *)AFIO_BASE) #define EXTI ((EXTI_TypeDef *)EXTI_BASE) #define
                GPIOA ((GPIO_TypeDef *)GPIOA_BASE) #define GPIOB ((GPIO_TypeDef
                *)GPIOB_BASE) #define GPIOC ((GPIO_TypeDef *)GPIOC_BASE) #define
                GPIOD ((GPIO_TypeDef *)GPIOD_BASE) #define GPIOE ((GPIO_TypeDef
                *)GPIOE_BASE) #define ADC1 ((ADC_TypeDef *)ADC1_BASE) #define
                ADC2 ((ADC_TypeDef *)ADC2_BASE) #define ADC12_COMMON
                ((ADC_Common_TypeDef *)ADC1_BASE) #define TIM1 ((TIM_TypeDef
                *)TIM1_BASE) #define SPI1 ((SPI_TypeDef *)SPI1_BASE) #define
                USART1 ((USART_TypeDef *)USART1_BASE) #define SDIO
                ((SDIO_TypeDef *)SDIO_BASE) #define DMA1 ((DMA_TypeDef
                *)DMA1_BASE) #define DMA1_Channel1 ((DMA_Channel_TypeDef
                *)DMA1_Channel1_BASE) #define DMA1_Channel2
                ((DMA_Channel_TypeDef *)DMA1_Channel2_BASE) #define
                DMA1_Channel3 ((DMA_Channel_TypeDef *)DMA1_Channel3_BASE)
                #define DMA1_Channel4 ((DMA_Channel_TypeDef
                *)DMA1_Channel4_BASE) #define DMA1_Channel5
                ((DMA_Channel_TypeDef *)DMA1_Channel5_BASE) #define
                DMA1_Channel6 ((DMA_Channel_TypeDef *)DMA1_Channel6_BASE)
                #define DMA1_Channel7 ((DMA_Channel_TypeDef
                *)DMA1_Channel7_BASE) #define RCC ((RCC_TypeDef *)RCC_BASE)
                #define CRC ((CRC_TypeDef *)CRC_BASE) #define FLASH
                ((FLASH_TypeDef *)FLASH_R_BASE) #define OB ((OB_TypeDef
                *)OB_BASE) #define DBGMCU ((DBGMCU_TypeDef *)DBGMCU_BASE)
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="c"
              data-enlighter-title=""
            >
#define TIM2                ((TIM_TypeDef *)TIM2_BASE)
  #define TIM3                ((TIM_TypeDef *)TIM3_BASE)
  #define TIM4                ((TIM_TypeDef *)TIM4_BASE)
  #define RTC                 ((RTC_TypeDef *)RTC_BASE)
  #define WWDG                ((WWDG_TypeDef *)WWDG_BASE)
  #define IWDG                ((IWDG_TypeDef *)IWDG_BASE)
  #define SPI2                ((SPI_TypeDef *)SPI2_BASE)
  #define USART2              ((USART_TypeDef *)USART2_BASE)
  #define USART3              ((USART_TypeDef *)USART3_BASE)
  #define I2C1                ((I2C_TypeDef *)I2C1_BASE)
  #define I2C2                ((I2C_TypeDef *)I2C2_BASE)
  #define USB                 ((USB_TypeDef *)USB_BASE)
  #define CAN1                ((CAN_TypeDef *)CAN1_BASE)
  #define BKP                 ((BKP_TypeDef *)BKP_BASE)
  #define PWR                 ((PWR_TypeDef *)PWR_BASE)
  #define AFIO                ((AFIO_TypeDef *)AFIO_BASE)
  #define EXTI                ((EXTI_TypeDef *)EXTI_BASE)
  #define GPIOA               ((GPIO_TypeDef *)GPIOA_BASE)
  #define GPIOB               ((GPIO_TypeDef *)GPIOB_BASE)
  #define GPIOC               ((GPIO_TypeDef *)GPIOC_BASE)
  #define GPIOD               ((GPIO_TypeDef *)GPIOD_BASE)
  #define GPIOE               ((GPIO_TypeDef *)GPIOE_BASE)
  #define ADC1                ((ADC_TypeDef *)ADC1_BASE)
  #define ADC2                ((ADC_TypeDef *)ADC2_BASE)
  #define ADC12_COMMON        ((ADC_Common_TypeDef *)ADC1_BASE)
  #define TIM1                ((TIM_TypeDef *)TIM1_BASE)
  #define SPI1                ((SPI_TypeDef *)SPI1_BASE)
  #define USART1              ((USART_TypeDef *)USART1_BASE)
  #define SDIO                ((SDIO_TypeDef *)SDIO_BASE)
  #define DMA1                ((DMA_TypeDef *)DMA1_BASE)
  #define DMA1_Channel1       ((DMA_Channel_TypeDef *)DMA1_Channel1_BASE)
  #define DMA1_Channel2       ((DMA_Channel_TypeDef *)DMA1_Channel2_BASE)
  #define DMA1_Channel3       ((DMA_Channel_TypeDef *)DMA1_Channel3_BASE)
  #define DMA1_Channel4       ((DMA_Channel_TypeDef *)DMA1_Channel4_BASE)
  #define DMA1_Channel5       ((DMA_Channel_TypeDef *)DMA1_Channel5_BASE)
  #define DMA1_Channel6       ((DMA_Channel_TypeDef *)DMA1_Channel6_BASE)
  #define DMA1_Channel7       ((DMA_Channel_TypeDef *)DMA1_Channel7_BASE)
  #define RCC                 ((RCC_TypeDef *)RCC_BASE)
  #define CRC                 ((CRC_TypeDef *)CRC_BASE)
  #define FLASH               ((FLASH_TypeDef *)FLASH_R_BASE)
  #define OB                  ((OB_TypeDef *)OB_BASE)
  #define DBGMCU              ((DBGMCU_TypeDef *)DBGMCU_BASE)</pre
            >
            <br />
            Рассмотрим, как выполняется обращение к регистрам из программы на
            Си. Например, нам надо в регистре&nbsp;<em>RCC_CR</em> установить
            бит&nbsp;<em>HSEON</em>. Это можно сделать одним из следующих
            способов:<br />
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-text">RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CR |= RCC_CR_HSEON_Msk;</span>
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">RCC-&gt;CR |= RCC_CR_HSEON_Msk;</div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="c"
              data-enlighter-title=""
            >
RCC-&gt;CR |= RCC_CR_HSEON_Msk;</pre
            >
            <br />
            или так:<br />
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-text">RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CR |= </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">1 </span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text"> RCC_CR_HSEON_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">;</span>
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                RCC-&gt;CR |= (1 &lt;&lt; RCC_CR_HSEON_Pos);
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="c"
              data-enlighter-title=""
            >
RCC-&gt;CR |= (1 &lt;&lt; RCC_CR_HSEON_Pos);</pre
            >
            <br />
            Думаю, те, кто раньше программировал для микроконтроллеров AVR
            увидят в этих записях что-то знакомое. Рассмотрим первый случай:
            <p></p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-591 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/n1.png"
                alt=""
                width="447"
                height="47"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/n1.png        447w,
                  http://dimoon.ru/wp-content/uploads/2018/08/n1-300x32.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/n1-250x26.png 250w,
                  http://dimoon.ru/wp-content/uploads/2018/08/n1-150x16.png 150w
                "
                sizes="(max-width: 447px) 100vw, 447px"
              />
            </p>
            <p>
              Сначала идет имя периферийного модуля, в нашем случае «RCC». Затем
              символ «-&gt;», после чего имя регистра
              «CR».&nbsp;&nbsp;RCC_CR_HSEON_Msk представляет собой вот такой
              #define:<br />
            </p>
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-c0"
                      >#define RCC_CR_HSEON_Msk (1&lt;&lt;16)</span
                    >
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                #define RCC_CR_HSEON_Msk (1&lt;&lt;16)
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="default"
              data-enlighter-title=""
            >
#define RCC_CR_HSEON_Msk    (1&lt;&lt;16)</pre
            >
            <br />
            где 16 — номер бита&nbsp;<em>HSEON</em> в регистре&nbsp;<em>CR</em>
            (см. рис. 1). <em>RCC_CR_HSEON_Msk</em> есть ни что иное, как
            битовая маска, имя которой состоит из названия периферийного модуля,
            имени регистра и бита, а так же постфикса <em>_Msk</em>. В CMSIS
            есть еще один #define, который является синонимом
            <em>RCC_CR_HSEON_Msk</em>:<br />
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-c0"
                      >#define RCC_CR_HSEON RCC_CR_HSEON_Msk</span
                    >
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                #define RCC_CR_HSEON RCC_CR_HSEON_Msk
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="default"
              data-enlighter-title=""
            >
#define RCC_CR_HSEON    RCC_CR_HSEON_Msk</pre
            >
            <br />
            По факту все то же самое, только без <em>_Msk.</em>
            <p></p>
            <p>Второй случай выглядит аналогичным образом:</p>
            <p>
              <img
                loading="lazy"
                class="aligncenter size-full wp-image-592 imageNone"
                src="http://dimoon.ru/wp-content/uploads/2018/08/n2.png"
                alt=""
                width="555"
                height="50"
                srcset="
                  http://dimoon.ru/wp-content/uploads/2018/08/n2.png        555w,
                  http://dimoon.ru/wp-content/uploads/2018/08/n2-300x27.png 300w,
                  http://dimoon.ru/wp-content/uploads/2018/08/n2-250x23.png 250w,
                  http://dimoon.ru/wp-content/uploads/2018/08/n2-150x14.png 150w
                "
                sizes="(max-width: 555px) 100vw, 555px"
              />
            </p>
            <p>где<br /></p>
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-k4"
                      >#define RCC_CR_HSEON_Pos 16</span
                    >
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">#define RCC_CR_HSEON_Pos 16</div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="c"
              data-enlighter-title=""
            >
#define RCC_CR_HSEON_Pos    16</pre
            >
            <br />
            То есть,&nbsp;<em>RCC_CR_HSEON_Pos</em> является позицией бита в
            регистре, о чем говорит постфикс <em>_Pos</em>.
            <p></p>
            <p>
              А как быть с параметрами, которые имеют несколько битов? К примеру
              в регистре&nbsp;<em>CFGR</em> мы хотим установить значение
              множителя <em>PLL</em> равное девяти, имеющее код 0111 (см. рис. 2
              биты&nbsp;<em>PLLMUL</em>). Тут вот такое решение:<br />
            </p>
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-text">RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text"
                      >CFGR |= RCC_CFGR_PLLMULL_0 | RCC_CFGR_PLLMULL_1 |
                      RCC_CFGR_PLLMULL_2;</span
                    >
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text">RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CFGR &amp;= ~</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">RCC_CFGR_PLLMULL_3</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">;</span>
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                RCC-&gt;CFGR |= RCC_CFGR_PLLMULL_0 | RCC_CFGR_PLLMULL_1 |
                RCC_CFGR_PLLMULL_2; RCC-&gt;CFGR &amp;= ~(RCC_CFGR_PLLMULL_3);
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="c"
              data-enlighter-title=""
            >
RCC-&gt;CFGR |= RCC_CFGR_PLLMULL_0 | RCC_CFGR_PLLMULL_1 | RCC_CFGR_PLLMULL_2;
  RCC-&gt;CFGR &amp;= ~(RCC_CFGR_PLLMULL_3);</pre
            >
            <br />
            Первой строчкой мы устанавливаем биты 0, 1 и 2&nbsp;<em>PLLMUL</em>
            в единицы, второй строчкой сбрасываем бит 3 в ноль, в итоге
            получаем&nbsp;0111. Однако, если мы уверены, что все биты&nbsp;<em
              >PLLMUL</em
            >
            изначально установлены в нули, то вторую строчку мы можем
            пропустить:<br />
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-text">RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text"
                      >CFGR |= RCC_CFGR_PLLMULL_0 | RCC_CFGR_PLLMULL_1 |
                      RCC_CFGR_PLLMULL_2;</span
                    >
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                RCC-&gt;CFGR |= RCC_CFGR_PLLMULL_0 | RCC_CFGR_PLLMULL_1 |
                RCC_CFGR_PLLMULL_2;
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="c"
              data-enlighter-title=""
            >
RCC-&gt;CFGR |= RCC_CFGR_PLLMULL_0 | RCC_CFGR_PLLMULL_1 | RCC_CFGR_PLLMULL_2;</pre
            >
            <br />
            А есть и еще один вариант: значение 0111 в десятичном виде является
            числом 7. Тогда можно сделать вот так:<br />
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-text">RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CFGR |= </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">7 </span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text"> RCC_CFGR_PLLMULL_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">;</span>
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                RCC-&gt;CFGR |= (7 &lt;&lt; RCC_CFGR_PLLMULL_Pos);
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="c"
              data-enlighter-title=""
            >
RCC-&gt;CFGR |= (7 &lt;&lt; RCC_CFGR_PLLMULL_Pos);</pre
            >
            <br />
            Но и тут надо помнить, что такая запись справедлива только в случае,
            если изначальное значение всех битов&nbsp;<em>PLLMUL</em> равны
            нулям.<br />
            <a name="nastroika"></a>
            <p></p>
            <h2>Настройка</h2>
            <p>
              Для правильной настройки системы тактирования в микроконтроллерах
              STM32 необходимо соблюдать определенную последовательность запуска
              блоков. Если мы хотим переключить систему с внутреннего
              RC-генератора на <em>HSE</em> через <em>PLL</em>, то необходимо
              провести следующие операции вот в таком порядке:
            </p>
            <ol>
              <li>Запустить генератор&nbsp;HSE</li>
              <li>Настроить PLL</li>
              <li>Запустить PLL</li>
              <li>Настроить количество циклов ожидания FLASH</li>
              <li>Настроить делители шин</li>
              <li>Переключиться на работу от PLL</li>
            </ol>
            <p>
              Так, вроде все понятно, хотя… А что это за 4-й пункт? Что за циклы
              ожидания <em>FLASH</em>? Вот здесь кроется один неочевидный
              момент. Дело в том, что <em>FLASH</em>-память микроконтроллера, в
              которой хранится управляющая программа, может работать на
              максимальной частоте 24 МГц. Обмен данными с
              <em>FLASH</em> осуществляется через шину <em>AHB</em> (см. рис.
              3). А если частота шины&nbsp;<em>AHB</em> выше 24 МГц, но
              необходимо ввести циклы ожидания обращений к этой памяти, примем,
              чем выше частота, тем больше этих циклов надо:
            </p>
            <ul>
              <li>ноль циклов ожидания, если 0 &lt; SYSCLK ≤ 24 MHz</li>
              <li>один цикл ожидания, если 24 MHz &lt; SYSCLK ≤ 48 MHz</li>
              <li>два цикла ожидания, если 48 MHz &lt; SYSCLK ≤ 72 MHz</li>
            </ul>
            <p>Надеюсь, с этим все ясно.</p>
            <p>Хочу отметить, что порядок настройки может быть и таким:</p>
            <ol>
              <li>Настроить количество циклов ожидания FLASH</li>
              <li>Настроить делители шин</li>
              <li>Запустить генератор&nbsp;HSE</li>
              <li>Настроить PLL</li>
              <li>Запустить PLL</li>
              <li>Переключиться на работу от PLL</li>
            </ol>
            <p>
              Просто надо помнить, что мы сидим на ветке, которую пилим, и важно
              все отпилить и подставить в нужной последовательности, чтоб не
              упасть. В случае с STM32, «упасть» не получится, так как в этих
              микроконтроллерах реализована аппаратная защита от неправильной
              последовательности действий: мы не сможем остановить генератор, от
              которого сейчас работаем или переключиться на источник тактового
              сигнала, если он еще не запущен. Так что в худшем случае у нас
              просто ни чего не получится, что то же является не очень приятным.
            </p>
            <p>
              Итак, поехали! Возьмем за основу проект, который мы создали во 2-й
              части, когда подключали CMSIS
            </p>
            <p>
              Создадим функцию, в которую будем добавлять код инициализации:<br />
            </p>
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-k5">int</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-m0">ClockInit</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-k5">void</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-g1">{</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-g1">}</span>
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">int ClockInit(void) { }</div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="c"
              data-enlighter-title=""
            >
int ClockInit(void)
  {
  }</pre
            >
            <br />
            Первым делом запускаем генератор <em>HSE</em>:<br />
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-text">RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CR |= </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">1</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CR_HSEON_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">; </span
                    ><span class="enlighter-c0">//Запускаем генератор HSE</span>
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                RCC-&gt;CR |= (1&lt;&lt;RCC_CR_HSEON_Pos); //Запускаем генератор
                HSE
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="c"
              data-enlighter-title=""
            >
RCC-&gt;CR |= (1&lt;&lt;RCC_CR_HSEON_Pos); //Запускаем генератор HSE</pre
            >
            <br />
            После этого нам надо дождаться установки флага&nbsp;<em>HSERDY</em>,
            который указывает на успешный запуск генератора. Можно это сделать
            по-простому с помощью цикла <em>while() {}</em>, но тогда мы рискуем
            зависнуть в нем навсегда, если что-то случится с кварцевым
            резонатором. Хотелось бы иметь возможность каким-то образом
            сигнализировать о невозможности запуска. Вот моя реализация:<br />
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-text">
                      __IO int StartUpCounter;</span
                    >
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"></span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//Ждем успешного запуска или окончания тайм-аута</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k1">for</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">StartUpCounter=</span
                    ><span class="enlighter-n1">0</span
                    ><span class="enlighter-text">; </span
                    ><span class="enlighter-g0">;</span
                    ><span class="enlighter-text"> StartUpCounter++</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-g1">{</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//Если успешно запустилось, то </span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0">//выходим из цикла</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k1">if</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CR </span
                    ><span class="enlighter-g0">&amp;</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-n1">1</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CR_HSERDY_Pos</span
                    ><span class="enlighter-g1">))</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"> break;</span></div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"> </span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0">//Если не запустилось, то</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//отключаем все, что включили</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0">//и возвращаем ошибку</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k1">if</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">StartUpCounter </span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-n2">0x1000</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-g1">{</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CR &amp;= ~</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-n1">1</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CR_HSEON_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">; </span
                    ><span class="enlighter-c0">//Останавливаем HSE</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k1">return</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-n1">1</span
                    ><span class="enlighter-text">;</span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-g1">}</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-g1">}</span>
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                __IO int StartUpCounter; //Ждем успешного запуска или окончания
                тайм-аута for(StartUpCounter=0; ; StartUpCounter++) { //Если
                успешно запустилось, то //выходим из цикла if(RCC-&gt;CR &amp;
                (1&lt;&lt;RCC_CR_HSERDY_Pos)) break; //Если не запустилось, то
                //отключаем все, что включили //и возвращаем ошибку
                if(StartUpCounter &gt; 0x1000) { RCC-&gt;CR &amp;=
                ~(1&lt;&lt;RCC_CR_HSEON_Pos); //Останавливаем HSE return 1; } }
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="default"
              data-enlighter-title=""
            >
  __IO int StartUpCounter;
  
    //Ждем успешного запуска или окончания тайм-аута
    for(StartUpCounter=0; ; StartUpCounter++)
    {
      //Если успешно запустилось, то 
      //выходим из цикла
      if(RCC-&gt;CR &amp; (1&lt;&lt;RCC_CR_HSERDY_Pos))
        break;
      
      //Если не запустилось, то
      //отключаем все, что включили
      //и возвращаем ошибку
      if(StartUpCounter &gt; 0x1000)
      {
        RCC-&gt;CR &amp;= ~(1&lt;&lt;RCC_CR_HSEON_Pos); //Останавливаем HSE
        return 1;
      }
    }</pre
            >
            <br />
            Тут реализован тайм-аут на запуск <em>HSE</em>. Если генератор успел
            запуститься до возникновения условия&nbsp;<em
              >if(StartUpCounter &gt; 0x1000)</em
            >, то мы выходим из цикла <em>for()</em> с помощью
            инструкции&nbsp;<em>break</em>.
            <p></p>
            <p>
              Так, <em>HSE</em> запустили. Переходим к настройке
              <em>PLL</em>:<br />
            </p>
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0">//Настраиваем PLL</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CFGR |= </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-n2">0x07</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CFGR_PLLMULL_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c0">//PLL множитель равен 9</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> | </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-n2">0x01</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CFGR_PLLSRC_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">; </span
                    ><span class="enlighter-c0">//Тактирование PLL от HSE</span>
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                //Настраиваем PLL RCC-&gt;CFGR |=
                (0x07&lt;&lt;RCC_CFGR_PLLMULL_Pos) //PLL множитель равен 9 |
                (0x01&lt;&lt;RCC_CFGR_PLLSRC_Pos); //Тактирование PLL от HSE
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="c"
              data-enlighter-title=""
            >
  //Настраиваем PLL
    RCC-&gt;CFGR |= (0x07&lt;&lt;RCC_CFGR_PLLMULL_Pos) //PLL множитель равен 9
              | (0x01&lt;&lt;RCC_CFGR_PLLSRC_Pos); //Тактирование PLL от HSE</pre
            >
            <br />
            Тут просто настраиваем коэффициент умножения и выбираем источник
            тактирования <em>PLL</em>. Далее, запускаем <em>PLL</em>:<br />
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-text">RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CR |= </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">1</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CR_PLLON_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">; </span
                    ><span class="enlighter-c0">//Запускаем PLL</span>
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                RCC-&gt;CR |= (1&lt;&lt;RCC_CR_PLLON_Pos); //Запускаем PLL
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="c"
              data-enlighter-title=""
            >
RCC-&gt;CR |= (1&lt;&lt;RCC_CR_PLLON_Pos); //Запускаем PLL</pre
            >
            <br />
            После этого ждем успешного запуска. Тут ожидание реализовано точно
            так же, как и для <em>HSE</em>:<br />
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//Ждем успешного запуска или окончания тайм-аута</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k1">for</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text"
                      >StartUpCounter=0; ; StartUpCounter++</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-g1">{</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//Если успешно запустилось, то </span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0">//выходим из цикла</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k1">if</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CR &amp; </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">1</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CR_PLLRDY_Pos</span
                    ><span class="enlighter-g1">))</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k1">break</span
                    ><span class="enlighter-text">;</span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"> </span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//Если по каким-то причинам не запустился PLL, то</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//отключаем все, что включили</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0">//и возвращаем ошибку</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k1">if</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">StartUpCounter </span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-n2">0x1000</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-g1">{</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CR &amp;= ~</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">1</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CR_HSEON_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">; </span
                    ><span class="enlighter-c0">//Останавливаем HSE</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CR &amp;= ~</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">1</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CR_PLLON_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">; </span
                    ><span class="enlighter-c0">//Останавливаем PLL</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k0">return</span
                    ><span class="enlighter-text"> 2;</span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-g1">}</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-g1">}</span>
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                //Ждем успешного запуска или окончания тайм-аута
                for(StartUpCounter=0; ; StartUpCounter++) { //Если успешно
                запустилось, то //выходим из цикла if(RCC-&gt;CR &amp;
                (1&lt;&lt;RCC_CR_PLLRDY_Pos)) break; //Если по каким-то причинам
                не запустился PLL, то //отключаем все, что включили //и
                возвращаем ошибку if(StartUpCounter &gt; 0x1000) { RCC-&gt;CR
                &amp;= ~(1&lt;&lt;RCC_CR_HSEON_Pos); //Останавливаем HSE
                RCC-&gt;CR &amp;= ~(1&lt;&lt;RCC_CR_PLLON_Pos); //Останавливаем
                PLL return 2; } }
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="c"
              data-enlighter-title=""
            >
  //Ждем успешного запуска или окончания тайм-аута
    for(StartUpCounter=0; ; StartUpCounter++)
    {
      //Если успешно запустилось, то 
      //выходим из цикла
      if(RCC-&gt;CR &amp; (1&lt;&lt;RCC_CR_PLLRDY_Pos))
        break;
      
      //Если по каким-то причинам не запустился PLL, то
      //отключаем все, что включили
      //и возвращаем ошибку
      if(StartUpCounter &gt; 0x1000)
      {
        RCC-&gt;CR &amp;= ~(1&lt;&lt;RCC_CR_HSEON_Pos); //Останавливаем HSE
        RCC-&gt;CR &amp;= ~(1&lt;&lt;RCC_CR_PLLON_Pos); //Останавливаем PLL
        return 2;
      }
    }</pre
            >
            <br />
            После этого настраиваем <em>FLASH</em> и делители:<br />
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//Устанавливаем 2 цикла ожидания для Flash</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//так как частота ядра у нас будет 48 MHz &lt; SYSCLK
                      &lt;= 72 MHz</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> FLASH-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">ACR |= </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-n2">0x02</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">FLASH_ACR_LATENCY_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">; </span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"> </span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0">//Делители</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CFGR |= </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-n2">0x00</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CFGR_PPRE2_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//Делитель шины APB2 отключен (оставляем 0 по
                      умолчанию)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> | </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-n2">0x04</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CFGR_PPRE1_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//Делитель нишы APB1 равен 2</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> | </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-n2">0x00</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CFGR_HPRE_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">; </span
                    ><span class="enlighter-c0"
                      >//Делитель AHB отключен (оставляем 0 по умолчанию)</span
                    >
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                //Устанавливаем 2 цикла ожидания для Flash //так как частота
                ядра у нас будет 48 MHz &lt; SYSCLK &lt;= 72 MHz FLASH-&gt;ACR
                |= (0x02&lt;&lt;FLASH_ACR_LATENCY_Pos); //Делители RCC-&gt;CFGR
                |= (0x00&lt;&lt;RCC_CFGR_PPRE2_Pos) //Делитель шины APB2
                отключен (оставляем 0 по умолчанию) |
                (0x04&lt;&lt;RCC_CFGR_PPRE1_Pos) //Делитель нишы APB1 равен 2 |
                (0x00&lt;&lt;RCC_CFGR_HPRE_Pos); //Делитель AHB отключен
                (оставляем 0 по умолчанию)
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="c"
              data-enlighter-title=""
            >
  //Устанавливаем 2 цикла ожидания для Flash
    //так как частота ядра у нас будет 48 MHz &lt; SYSCLK &lt;= 72 MHz
    FLASH-&gt;ACR |= (0x02&lt;&lt;FLASH_ACR_LATENCY_Pos); 
    
    //Делители
    RCC-&gt;CFGR |= (0x00&lt;&lt;RCC_CFGR_PPRE2_Pos) //Делитель шины APB2 отключен (оставляем 0 по умолчанию)
              | (0x04&lt;&lt;RCC_CFGR_PPRE1_Pos) //Делитель нишы APB1 равен 2
              | (0x00&lt;&lt;RCC_CFGR_HPRE_Pos); //Делитель AHB отключен (оставляем 0 по умолчанию)</pre
            >
            <br />
            Ну и торжественный момент переключение на работу от
            <em>PLL</em>:<br />
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-text">RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CFGR |= </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-n2">0x02</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CFGR_SW_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">; </span
                    ><span class="enlighter-c0"
                      >//Переключаемся на работу от PLL</span
                    >
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                RCC-&gt;CFGR |= (0x02&lt;&lt;RCC_CFGR_SW_Pos); //Переключаемся
                на работу от PLL
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="c"
              data-enlighter-title=""
            >
RCC-&gt;CFGR |= (0x02&lt;&lt;RCC_CFGR_SW_Pos); //Переключаемся на работу от PLL</pre
            >
            <br />
            Ждем завершения переключения:<br />
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0">//Ждем, пока переключимся</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k1">while</span
                    ><span class="enlighter-g1">((</span
                    ><span class="enlighter-text">RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text"
                      >CFGR &amp; RCC_CFGR_SWS_Msk</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> != </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-n2">0x02</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CFGR_SWS_Pos</span
                    ><span class="enlighter-g1">))</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-g1">{</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-g1">}</span>
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                //Ждем, пока переключимся while((RCC-&gt;CFGR &amp;
                RCC_CFGR_SWS_Msk) != (0x02&lt;&lt;RCC_CFGR_SWS_Pos)) { }
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="c"
              data-enlighter-title=""
            >
  //Ждем, пока переключимся
    while((RCC-&gt;CFGR &amp; RCC_CFGR_SWS_Msk) != (0x02&lt;&lt;RCC_CFGR_SWS_Pos))
    {
    }</pre
            >
            <br />
            Поздравляю! Мы запустились от <em>PLL</em>! После этого можно
            отключить RC-генератор <em>HSI</em>, так как он нам больше не
            нужен:<br />
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//После того, как переключились на</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//внешний источник такирования</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//отключаем внутренний RC-генератор</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0">//для экономии энергии</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CR &amp;= ~</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">1</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CR_HSION_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">;</span>
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                //После того, как переключились на //внешний источник
                такирования //отключаем внутренний RC-генератор //для экономии
                энергии RCC-&gt;CR &amp;= ~(1&lt;&lt;RCC_CR_HSION_Pos);
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="c"
              data-enlighter-title=""
            >
  //После того, как переключились на
    //внешний источник такирования
    //отключаем внутренний RC-генератор
    //для экономии энергии
    RCC-&gt;CR &amp;= ~(1&lt;&lt;RCC_CR_HSION_Pos);</pre
            >
            <br />
            Приведу весь код функции переключения на работу от
            <em>PLL</em>:<br />
            <div
              class="enlighter-default enlighter-v-standard enlighter-t-enlighter enlighter-hover enlighter-linenumbers"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-c0"
                      >//Настраиваем тактирование системы от внешнего
                      кварца</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-c0"
                      >//через PLL на саксимально возможных частотах.</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-c0"
                      >//Внешний кварц должен быть на 8МГц</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-c0">//Возвращает:</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-c0">// 0 - завершено успешно</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-c0"
                      >// 1 - не запустился кварцевый генератор</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-c0">// 2 - не запустился PLL</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k5">int</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-m0">ClockInit</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-k5">void</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-g1">{</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> __IO </span
                    ><span class="enlighter-k5">int</span
                    ><span class="enlighter-text"> StartUpCounter;</span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"> </span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >////////////////////////////////////////////////////////////</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//Запускаем кварцевый генератор</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >////////////////////////////////////////////////////////////</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"> </span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CR |= </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">1</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CR_HSEON_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">; </span
                    ><span class="enlighter-c0">//Запускаем генератор HSE</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"> </span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//Ждем успешного запуска или окончания тайм-аута</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k1">for</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text"
                      >StartUpCounter=0; ; StartUpCounter++</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-g1">{</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//Если успешно запустилось, то </span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0">//выходим из цикла</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k1">if</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CR &amp; </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">1</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CR_HSERDY_Pos</span
                    ><span class="enlighter-g1">))</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k1">break</span
                    ><span class="enlighter-text">;</span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"> </span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0">//Если не запустилось, то</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//отключаем все, что включили</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0">//и возвращаем ошибку</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k1">if</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">StartUpCounter </span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-n2">0x1000</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-g1">{</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CR &amp;= ~</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">1</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CR_HSEON_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">; </span
                    ><span class="enlighter-c0">//Останавливаем HSE</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k0">return</span
                    ><span class="enlighter-text"> 1;</span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-g1">}</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-g1">}</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"> </span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >////////////////////////////////////////////////////////////</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//Настраиваем и запускаем PLL</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >////////////////////////////////////////////////////////////</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"> </span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0">//Настраиваем PLL</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CFGR |= </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-n2">0x07</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CFGR_PLLMULL_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c0">//PLL множитель равен 9</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> | </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-n2">0x01</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CFGR_PLLSRC_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">; </span
                    ><span class="enlighter-c0">//Тактирование PLL от HSE</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"> </span></div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"> </span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CR |= </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">1</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CR_PLLON_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">; </span
                    ><span class="enlighter-c0">//Запускаем PLL</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"> </span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//Ждем успешного запуска или окончания тайм-аута</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k1">for</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text"
                      >StartUpCounter=0; ; StartUpCounter++</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-g1">{</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//Если успешно запустилось, то </span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0">//выходим из цикла</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k1">if</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CR &amp; </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">1</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CR_PLLRDY_Pos</span
                    ><span class="enlighter-g1">))</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k1">break</span
                    ><span class="enlighter-text">;</span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"> </span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//Если по каким-то причинам не запустился PLL, то</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//отключаем все, что включили</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0">//и возвращаем ошибку</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k1">if</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">StartUpCounter </span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-n2">0x1000</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-g1">{</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CR &amp;= ~</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">1</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CR_HSEON_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">; </span
                    ><span class="enlighter-c0">//Останавливаем HSE</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CR &amp;= ~</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">1</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CR_PLLON_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">; </span
                    ><span class="enlighter-c0">//Останавливаем PLL</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k0">return</span
                    ><span class="enlighter-text"> 2;</span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-g1">}</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-g1">}</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"> </span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >////////////////////////////////////////////////////////////</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//Настраиваем FLASH и делители</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >////////////////////////////////////////////////////////////</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"> </span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//Устанавливаем 2 цикла ожидания для Flash</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//так как частота ядра у нас будет 48 MHz &lt; SYSCLK
                      &lt;= 72 MHz</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> FLASH-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">ACR |= </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-n2">0x02</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">FLASH_ACR_LATENCY_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">; </span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"> </span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0">//Делители</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CFGR |= </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-n2">0x00</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CFGR_PPRE2_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//Делитель шины APB2 отключен</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> | </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-n2">0x04</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CFGR_PPRE1_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//Делитель нишы APB1 равен 2</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> | </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-n2">0x00</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CFGR_HPRE_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">; </span
                    ><span class="enlighter-c0">//Делитель AHB отключен</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"> </span></div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"> </span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CFGR |= </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-n2">0x02</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CFGR_SW_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">; </span
                    ><span class="enlighter-c0"
                      >//Переключаемся на работу от PLL</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"> </span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0">//Ждем, пока переключимся</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k1">while</span
                    ><span class="enlighter-g1">((</span
                    ><span class="enlighter-text">RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text"
                      >CFGR &amp; RCC_CFGR_SWS_Msk</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"> != </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-n2">0x02</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CFGR_SWS_Pos</span
                    ><span class="enlighter-g1">))</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-g1">{</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-g1">}</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"> </span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//После того, как переключились на</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//внешний источник такирования</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//отключаем внутренний RC-генератор</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0">//для экономии энергии</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> RCC-</span
                    ><span class="enlighter-g1">&gt;</span
                    ><span class="enlighter-text">CR &amp;= ~</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">1</span
                    ><span class="enlighter-g1">&lt;&lt;</span
                    ><span class="enlighter-text">RCC_CR_HSION_Pos</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">;</span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"> </span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//Настройка и переклбючение сисемы</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//на внешний кварцевый генератор</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0"
                      >//и PLL запершилось успехом.</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c0">//Выходим</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k0">return</span
                    ><span class="enlighter-text"> 0;</span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-g1">}</span>
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                //Настраиваем тактирование системы от внешнего кварца //через
                PLL на саксимально возможных частотах. //Внешний кварц должен
                быть на 8МГц //Возвращает: // 0 - завершено успешно // 1 - не
                запустился кварцевый генератор // 2 - не запустился PLL int
                ClockInit(void) { __IO int StartUpCounter;
                ////////////////////////////////////////////////////////////
                //Запускаем кварцевый генератор
                ////////////////////////////////////////////////////////////
                RCC-&gt;CR |= (1&lt;&lt;RCC_CR_HSEON_Pos); //Запускаем генератор
                HSE //Ждем успешного запуска или окончания тайм-аута
                for(StartUpCounter=0; ; StartUpCounter++) { //Если успешно
                запустилось, то //выходим из цикла if(RCC-&gt;CR &amp;
                (1&lt;&lt;RCC_CR_HSERDY_Pos)) break; //Если не запустилось, то
                //отключаем все, что включили //и возвращаем ошибку
                if(StartUpCounter &gt; 0x1000) { RCC-&gt;CR &amp;=
                ~(1&lt;&lt;RCC_CR_HSEON_Pos); //Останавливаем HSE return 1; } }
                ////////////////////////////////////////////////////////////
                //Настраиваем и запускаем PLL
                ////////////////////////////////////////////////////////////
                //Настраиваем PLL RCC-&gt;CFGR |=
                (0x07&lt;&lt;RCC_CFGR_PLLMULL_Pos) //PLL множитель равен 9 |
                (0x01&lt;&lt;RCC_CFGR_PLLSRC_Pos); //Тактирование PLL от HSE
                RCC-&gt;CR |= (1&lt;&lt;RCC_CR_PLLON_Pos); //Запускаем PLL
                //Ждем успешного запуска или окончания тайм-аута
                for(StartUpCounter=0; ; StartUpCounter++) { //Если успешно
                запустилось, то //выходим из цикла if(RCC-&gt;CR &amp;
                (1&lt;&lt;RCC_CR_PLLRDY_Pos)) break; //Если по каким-то причинам
                не запустился PLL, то //отключаем все, что включили //и
                возвращаем ошибку if(StartUpCounter &gt; 0x1000) { RCC-&gt;CR
                &amp;= ~(1&lt;&lt;RCC_CR_HSEON_Pos); //Останавливаем HSE
                RCC-&gt;CR &amp;= ~(1&lt;&lt;RCC_CR_PLLON_Pos); //Останавливаем
                PLL return 2; } }
                ////////////////////////////////////////////////////////////
                //Настраиваем FLASH и делители
                ////////////////////////////////////////////////////////////
                //Устанавливаем 2 цикла ожидания для Flash //так как частота
                ядра у нас будет 48 MHz &lt; SYSCLK &lt;= 72 MHz FLASH-&gt;ACR
                |= (0x02&lt;&lt;FLASH_ACR_LATENCY_Pos); //Делители RCC-&gt;CFGR
                |= (0x00&lt;&lt;RCC_CFGR_PPRE2_Pos) //Делитель шины APB2
                отключен | (0x04&lt;&lt;RCC_CFGR_PPRE1_Pos) //Делитель нишы APB1
                равен 2 | (0x00&lt;&lt;RCC_CFGR_HPRE_Pos); //Делитель AHB
                отключен RCC-&gt;CFGR |= (0x02&lt;&lt;RCC_CFGR_SW_Pos);
                //Переключаемся на работу от PLL //Ждем, пока переключимся
                while((RCC-&gt;CFGR &amp; RCC_CFGR_SWS_Msk) !=
                (0x02&lt;&lt;RCC_CFGR_SWS_Pos)) { } //После того, как
                переключились на //внешний источник такирования //отключаем
                внутренний RC-генератор //для экономии энергии RCC-&gt;CR &amp;=
                ~(1&lt;&lt;RCC_CR_HSION_Pos); //Настройка и переклбючение сисемы
                //на внешний кварцевый генератор //и PLL запершилось успехом.
                //Выходим return 0; }
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="c"
              data-enlighter-title=""
            >
//Настраиваем тактирование системы от внешнего кварца
  //через PLL на саксимально возможных частотах.
  //Внешний кварц должен быть на 8МГц
  //Возвращает:
  //  0 - завершено успешно
  //  1 - не запустился кварцевый генератор
  //  2 - не запустился PLL
  int ClockInit(void)
  {
    __IO int StartUpCounter;
    
    ////////////////////////////////////////////////////////////
    //Запускаем кварцевый генератор
    ////////////////////////////////////////////////////////////
    
    RCC-&gt;CR |= (1&lt;&lt;RCC_CR_HSEON_Pos); //Запускаем генератор HSE
    
    //Ждем успешного запуска или окончания тайм-аута
    for(StartUpCounter=0; ; StartUpCounter++)
    {
      //Если успешно запустилось, то 
      //выходим из цикла
      if(RCC-&gt;CR &amp; (1&lt;&lt;RCC_CR_HSERDY_Pos))
        break;
      
      //Если не запустилось, то
      //отключаем все, что включили
      //и возвращаем ошибку
      if(StartUpCounter &gt; 0x1000)
      {
        RCC-&gt;CR &amp;= ~(1&lt;&lt;RCC_CR_HSEON_Pos); //Останавливаем HSE
        return 1;
      }
    }
    
    ////////////////////////////////////////////////////////////
    //Настраиваем и запускаем PLL
    ////////////////////////////////////////////////////////////
    
    //Настраиваем PLL
    RCC-&gt;CFGR |= (0x07&lt;&lt;RCC_CFGR_PLLMULL_Pos) //PLL множитель равен 9
              | (0x01&lt;&lt;RCC_CFGR_PLLSRC_Pos); //Тактирование PLL от HSE
    
    
    RCC-&gt;CR |= (1&lt;&lt;RCC_CR_PLLON_Pos); //Запускаем PLL
    
    //Ждем успешного запуска или окончания тайм-аута
    for(StartUpCounter=0; ; StartUpCounter++)
    {
      //Если успешно запустилось, то 
      //выходим из цикла
      if(RCC-&gt;CR &amp; (1&lt;&lt;RCC_CR_PLLRDY_Pos))
        break;
      
      //Если по каким-то причинам не запустился PLL, то
      //отключаем все, что включили
      //и возвращаем ошибку
      if(StartUpCounter &gt; 0x1000)
      {
        RCC-&gt;CR &amp;= ~(1&lt;&lt;RCC_CR_HSEON_Pos); //Останавливаем HSE
        RCC-&gt;CR &amp;= ~(1&lt;&lt;RCC_CR_PLLON_Pos); //Останавливаем PLL
        return 2;
      }
    }
    
    ////////////////////////////////////////////////////////////
    //Настраиваем FLASH и делители
    ////////////////////////////////////////////////////////////
    
    //Устанавливаем 2 цикла ожидания для Flash
    //так как частота ядра у нас будет 48 MHz &lt; SYSCLK &lt;= 72 MHz
    FLASH-&gt;ACR |= (0x02&lt;&lt;FLASH_ACR_LATENCY_Pos); 
    
    //Делители
    RCC-&gt;CFGR |= (0x00&lt;&lt;RCC_CFGR_PPRE2_Pos) //Делитель шины APB2 отключен
              | (0x04&lt;&lt;RCC_CFGR_PPRE1_Pos) //Делитель нишы APB1 равен 2
              | (0x00&lt;&lt;RCC_CFGR_HPRE_Pos); //Делитель AHB отключен
    
    
    RCC-&gt;CFGR |= (0x02&lt;&lt;RCC_CFGR_SW_Pos); //Переключаемся на работу от PLL
    
    //Ждем, пока переключимся
    while((RCC-&gt;CFGR &amp; RCC_CFGR_SWS_Msk) != (0x02&lt;&lt;RCC_CFGR_SWS_Pos))
    {
    }
    
    //После того, как переключились на
    //внешний источник такирования
    //отключаем внутренний RC-генератор
    //для экономии энергии
    RCC-&gt;CR &amp;= ~(1&lt;&lt;RCC_CR_HSION_Pos);
    
    //Настройка и переклбючение сисемы
    //на внешний кварцевый генератор
    //и PLL запершилось успехом.
    //Выходим
    return 0;
  }</pre
            >
            <br />
          </div>
        </div>
        <h2>STM32. Быстрый старт с STM32CubeMx. Автор: Aveal</h2>
        <div class="accordion-item">
          <div class="accordion-header">Быстрый старт с STM32CubeMx</div>
          <div class="accordion-content">
            <p>
              Всем нам известная фирма ST Microelectronics активно развивает
              свой продукт под названием <strong>STM32CubeMx</strong>, и я не
              мог обойти это вниманием, поэтому и решил сделать новую
              одноименную рубрику. И для начала разберемся, что это вообще
              такое, и для чего нужно. Итак...
            </p>

            <p>
              STM32CubeMx - программный продукт, позволяющий легко и
              непринужденно при помощи достаточно понятного графического
              интерфейса произвести настройку любой имеющейся на борту
              микроконтроллера периферии. Предыстория создания CubeMx такова -
              ST имеют очень разнообразную линейку микроконтроллеров, тут и
              Cortex-M0, и Cortex-M0+, и Cortex-M3, и Cortex-M4. Соответственно,
              встает вопрос о каком-то едином наборе библиотек и едином
              инструменте для инициализации и конфигурирования всего этого
              многообразия. Вот для решения этих целей и был выпущен
              STM32CubeMx.
            </p>

            <p>
              Суть концепции такова - создаем проект, выбираем микроконтроллер,
              и нам сразу же предлагается схема со всеми выводами выбранного
              контроллера. Нажимая на выводы и заходя в разнообразные меню, мы
              легко настраиваем как периферию, так и режимы работы каждого
              конкретного вывода. Сразу же очевидные плюсы - можно наглядно
              увидеть, какие выводы уже заняты, а какие еще свободны (в крупных
              проектах - более чем полезная функция). Давайте рассмотрим все
              вышеперечисленное на практическом примере.
            </p>

            <p>
              Собственно, устанавливаем STM32CubeMx, запускаем и создаем новый
              проект:
            </p>

            <div class="wp-block-image">
              <figure class="aligncenter size-full is-resized">
                <img
                  decoding="async"
                  src="https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-new-project.jpg"
                  alt="Создание нового проекта в STM32CubeMx"
                  class="wp-image-15756 entered lazyloaded"
                  width="855"
                  height="480"
                  data-lazy-srcset="https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-new-project.jpg 900w, https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-new-project-600x337.jpg 600w, https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-new-project-150x84.jpg 150w, https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-new-project-768x432.jpg 768w"
                  data-lazy-sizes="(max-width: 855px) 100vw, 855px"
                  data-lazy-src="https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-new-project.jpg"
                  data-ll-status="loaded"
                  sizes="(max-width: 855px) 100vw, 855px"
                  srcset="
                    https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-new-project.jpg         900w,
                    https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-new-project-600x337.jpg 600w,
                    https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-new-project-150x84.jpg  150w,
                    https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-new-project-768x432.jpg 768w
                  "
                /><noscript
                  ><img
                    decoding="async"
                    src="https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-new-project.jpg"
                    alt="Создание нового проекта в STM32CubeMx"
                    class="wp-image-15756"
                    width="855"
                    height="480"
                    srcset="
                      https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-new-project.jpg         900w,
                      https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-new-project-600x337.jpg 600w,
                      https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-new-project-150x84.jpg  150w,
                      https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-new-project-768x432.jpg 768w
                    "
                    sizes="(max-width: 855px) 100vw, 855px"
                /></noscript>
              </figure>
            </div>

            <p>
              Сразу же открывается окно с огромным количеством фильтров, в
              котором необходимо выбрать микроконтроллер, который мы собираемся
              использовать в проекте. Я выбрал
              <strong>STM32F407VG</strong>:
            </p>

            <div class="wp-block-image">
              <figure class="aligncenter size-full is-resized">
                <img
                  width="855"
                  height="381"
                  decoding="async"
                  alt="Выбор микроконтроллера"
                  class="wp-image-15757 entered lazyloaded"
                  data-lazy-srcset="https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-mcu.jpg 900w, https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-mcu-600x267.jpg 600w, https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-mcu-150x67.jpg 150w, https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-mcu-768x342.jpg 768w"
                  data-lazy-sizes="(max-width: 900px) 100vw, 900px"
                  data-lazy-src="https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-mcu.jpg"
                  src="https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-mcu.jpg"
                  data-ll-status="loaded"
                  sizes="(max-width: 900px) 100vw, 900px"
                  srcset="
                    https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-mcu.jpg         900w,
                    https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-mcu-600x267.jpg 600w,
                    https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-mcu-150x67.jpg  150w,
                    https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-mcu-768x342.jpg 768w
                  "
                /><noscript
                  ><img
                    width="855"
                    height="381"
                    decoding="async"
                    src="https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-mcu.jpg"
                    alt="Выбор микроконтроллера"
                    class="wp-image-15757"
                    srcset="
                      https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-mcu.jpg         900w,
                      https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-mcu-600x267.jpg 600w,
                      https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-mcu-150x67.jpg  150w,
                      https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-mcu-768x342.jpg 768w
                    "
                    sizes="(max-width: 900px) 100vw, 900px"
                /></noscript>
              </figure>
            </div>

            <p>
              В результате будет открыто окно для работы с созданным проектом:
            </p>

            <div class="wp-block-image">
              <figure class="aligncenter size-full is-resized">
                <img
                  width="855"
                  height="461"
                  decoding="async"
                  src="https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-project.jpg"
                  alt="Основное окно STM32CubeMx"
                  class="wp-image-15758 entered lazyloaded"
                  data-lazy-srcset="https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-project.jpg 900w, https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-project-600x323.jpg 600w, https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-project-150x81.jpg 150w, https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-project-768x414.jpg 768w"
                  data-lazy-sizes="(max-width: 900px) 100vw, 900px"
                  data-lazy-src="https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-project.jpg"
                  data-ll-status="loaded"
                  sizes="(max-width: 900px) 100vw, 900px"
                  srcset="
                    https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-project.jpg         900w,
                    https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-project-600x323.jpg 600w,
                    https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-project-150x81.jpg  150w,
                    https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-project-768x414.jpg 768w
                  "
                /><noscript
                  ><img
                    width="855"
                    height="461"
                    decoding="async"
                    src="https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-project.jpg"
                    alt="Основное окно STM32CubeMx"
                    class="wp-image-15758"
                    srcset="
                      https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-project.jpg         900w,
                      https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-project-600x323.jpg 600w,
                      https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-project-150x81.jpg  150w,
                      https://microtechnics.ru/wp-content/uploads/2022/01/stm32cubemx-project-768x414.jpg 768w
                    "
                    sizes="(max-width: 900px) 100vw, 900px"
                /></noscript>
              </figure>
            </div>

            <p>
              И тут мы уже видим в правой части изображение нашего контроллера
              со всеми выводами, а слева список всей доступной периферии.
              Соответственно, можно, кликая на выводы, задавать их режимы
              работы, либо в списке периферии активировать те или иные модули.
            </p>

            <p>
              На вкладке Clock Configuration задаются все необходимые параметры
              тактирования, об этом пойдет речь в одной из следующих статей
              <a
                href="https://microtechnics.ru/category/uchebnye-kursy/stm32cubemx-ru/"
                >курса</a
              >.
            </p>

            <p>
              Если мы зайдем во вкладку Project Manager, то сможем
              последовательно настроить (перечисляю основное):
            </p>

            <ul>
              <li>имя проекта</li>

              <li>путь для сохранения проекта</li>

              <li>
                среду разработки, для которой будут сгенерированы файлы проекта
              </li>

              <li>
                версию библиотек, которые будут использованы для генерации
                исходного кода
              </li>
            </ul>

            <div class="wp-block-image">
              <figure class="aligncenter size-full is-resized">
                <img
                  decoding="async"
                  src="https://microtechnics.ru/wp-content/uploads/2022/01/cubemx-project-settings.jpg"
                  alt="Настройки проекта"
                  class="wp-image-15776 entered lazyloaded"
                  width="628"
                  height="611"
                  data-lazy-srcset="https://microtechnics.ru/wp-content/uploads/2022/01/cubemx-project-settings.jpg 800w, https://microtechnics.ru/wp-content/uploads/2022/01/cubemx-project-settings-411x400.jpg 411w, https://microtechnics.ru/wp-content/uploads/2022/01/cubemx-project-settings-150x146.jpg 150w, https://microtechnics.ru/wp-content/uploads/2022/01/cubemx-project-settings-768x747.jpg 768w"
                  data-lazy-sizes="(max-width: 628px) 100vw, 628px"
                  data-lazy-src="https://microtechnics.ru/wp-content/uploads/2022/01/cubemx-project-settings.jpg"
                  data-ll-status="loaded"
                  sizes="(max-width: 628px) 100vw, 628px"
                  srcset="
                    https://microtechnics.ru/wp-content/uploads/2022/01/cubemx-project-settings.jpg         800w,
                    https://microtechnics.ru/wp-content/uploads/2022/01/cubemx-project-settings-411x400.jpg 411w,
                    https://microtechnics.ru/wp-content/uploads/2022/01/cubemx-project-settings-150x146.jpg 150w,
                    https://microtechnics.ru/wp-content/uploads/2022/01/cubemx-project-settings-768x747.jpg 768w
                  "
                /><noscript
                  ><img
                    decoding="async"
                    src="https://microtechnics.ru/wp-content/uploads/2022/01/cubemx-project-settings.jpg"
                    alt="Настройки проекта"
                    class="wp-image-15776"
                    width="628"
                    height="611"
                    srcset="
                      https://microtechnics.ru/wp-content/uploads/2022/01/cubemx-project-settings.jpg         800w,
                      https://microtechnics.ru/wp-content/uploads/2022/01/cubemx-project-settings-411x400.jpg 411w,
                      https://microtechnics.ru/wp-content/uploads/2022/01/cubemx-project-settings-150x146.jpg 150w,
                      https://microtechnics.ru/wp-content/uploads/2022/01/cubemx-project-settings-768x747.jpg 768w
                    "
                    sizes="(max-width: 628px) 100vw, 628px"
                /></noscript>
              </figure>
            </div>

            <p>
              Давайте для примера выберем что-нибудь. Пусть будет задействован
              первый канал АЦП (PA0) и три вывода, работающих в режиме выхода
              (PE4, PD13, PC0):
            </p>

            <div class="wp-block-image">
              <figure class="aligncenter size-full is-resized">
                <img
                  decoding="async"
                  src="https://microtechnics.ru/wp-content/uploads/2022/01/primer-proekta.jpg"
                  alt="Pinout в STM32CubeMx"
                  class="wp-image-15759 entered lazyloaded"
                  width="722"
                  height="629"
                  data-lazy-srcset="https://microtechnics.ru/wp-content/uploads/2022/01/primer-proekta.jpg 900w, https://microtechnics.ru/wp-content/uploads/2022/01/primer-proekta-459x400.jpg 459w, https://microtechnics.ru/wp-content/uploads/2022/01/primer-proekta-150x131.jpg 150w, https://microtechnics.ru/wp-content/uploads/2022/01/primer-proekta-768x669.jpg 768w"
                  data-lazy-sizes="(max-width: 722px) 100vw, 722px"
                  data-lazy-src="https://microtechnics.ru/wp-content/uploads/2022/01/primer-proekta.jpg"
                  data-ll-status="loaded"
                  sizes="(max-width: 722px) 100vw, 722px"
                  srcset="
                    https://microtechnics.ru/wp-content/uploads/2022/01/primer-proekta.jpg         900w,
                    https://microtechnics.ru/wp-content/uploads/2022/01/primer-proekta-459x400.jpg 459w,
                    https://microtechnics.ru/wp-content/uploads/2022/01/primer-proekta-150x131.jpg 150w,
                    https://microtechnics.ru/wp-content/uploads/2022/01/primer-proekta-768x669.jpg 768w
                  "
                /><noscript
                  ><img
                    decoding="async"
                    src="https://microtechnics.ru/wp-content/uploads/2022/01/primer-proekta.jpg"
                    alt="Pinout в STM32CubeMx"
                    class="wp-image-15759"
                    width="722"
                    height="629"
                    srcset="
                      https://microtechnics.ru/wp-content/uploads/2022/01/primer-proekta.jpg         900w,
                      https://microtechnics.ru/wp-content/uploads/2022/01/primer-proekta-459x400.jpg 459w,
                      https://microtechnics.ru/wp-content/uploads/2022/01/primer-proekta-150x131.jpg 150w,
                      https://microtechnics.ru/wp-content/uploads/2022/01/primer-proekta-768x669.jpg 768w
                    "
                    sizes="(max-width: 722px) 100vw, 722px"
                /></noscript>
              </figure>
            </div>

            <ul>
              <li>
                <em
                  >кроме того, если планируется использовать отладчик,
                  необходимо в пункте SYS выбрать отладочный интерфейс.
                  Например, для отладчика ST-Link настройки будут выглядеть
                  так:</em
                >
              </li>
            </ul>

            <div class="wp-block-image">
              <figure class="aligncenter size-full is-resized">
                <img
                  decoding="async"
                  alt="Включение отладочного интерфейса"
                  class="wp-image-15760 entered lazyloaded"
                  width="660"
                  height="249"
                  data-lazy-srcset="https://microtechnics.ru/wp-content/uploads/2022/01/st-link-settings.jpg 700w, https://microtechnics.ru/wp-content/uploads/2022/01/st-link-settings-600x226.jpg 600w, https://microtechnics.ru/wp-content/uploads/2022/01/st-link-settings-150x57.jpg 150w"
                  data-lazy-sizes="(max-width: 660px) 100vw, 660px"
                  data-lazy-src="https://microtechnics.ru/wp-content/uploads/2022/01/st-link-settings.jpg"
                  src="https://microtechnics.ru/wp-content/uploads/2022/01/st-link-settings.jpg"
                  data-ll-status="loaded"
                  sizes="(max-width: 660px) 100vw, 660px"
                  srcset="
                    https://microtechnics.ru/wp-content/uploads/2022/01/st-link-settings.jpg         700w,
                    https://microtechnics.ru/wp-content/uploads/2022/01/st-link-settings-600x226.jpg 600w,
                    https://microtechnics.ru/wp-content/uploads/2022/01/st-link-settings-150x57.jpg  150w
                  "
                /><noscript
                  ><img
                    decoding="async"
                    src="https://microtechnics.ru/wp-content/uploads/2022/01/st-link-settings.jpg"
                    alt="Включение отладочного интерфейса"
                    class="wp-image-15760"
                    width="660"
                    height="249"
                    srcset="
                      https://microtechnics.ru/wp-content/uploads/2022/01/st-link-settings.jpg         700w,
                      https://microtechnics.ru/wp-content/uploads/2022/01/st-link-settings-600x226.jpg 600w,
                      https://microtechnics.ru/wp-content/uploads/2022/01/st-link-settings-150x57.jpg  150w
                    "
                    sizes="(max-width: 660px) 100vw, 660px"
                /></noscript>
              </figure>
            </div>

            <p>
              Готово, теперь нажимаем на кнопку "Generate Code" в правом верхнем
              углу, и CubeMx предложит нам скачать необходимые библиотеки (в
              случае их отсутствия). Не препятствуем данному процессу, ждем.
            </p>

            <p>
              После окончания генерации открываем папку с нашим проектом и
              видим, что там появились новые файлы. В папке
              <em>Drivers </em>содержатся все необходимые библиотеки, а в папках
              <em>src </em>и <em>inc</em>, соответственно, сами файлы со
              сгенерированным кодом. Откроем, например, <em>main.c</em>:
            </p>

            <div
              class="enlighter-default enlighter-v-standard enlighter-t-godzilla enlighter-hover enlighter-linenumbers enlighter-overflow-scroll"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-c1"
                      >/***************************************************************************************/</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-k5">int</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-m0">main</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-k5">void</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-g1">{</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"></span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* USER CODE BEGIN 1 */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"></span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* USER CODE END 1 */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"></span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/* MCU
                      Configuration----------------------------------------------------------*/</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"></span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/* Reset of all peripherals, Initializes the Flash
                      interface and the Systick. */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-m0">HAL_Init</span
                    ><span class="enlighter-g1">()</span
                    ><span class="enlighter-text">;</span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"></span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/* Configure the system clock */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-m0">SystemClock_Config</span
                    ><span class="enlighter-g1">()</span
                    ><span class="enlighter-text">;</span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"></span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* System interrupt init*/</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/* Sets the priority grouping field */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-m0"
                      >HAL_NVIC_SetPriorityGrouping</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">NVIC_PRIORITYGROUP_0</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">;</span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-m0">HAL_NVIC_SetPriority</span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">SysTick_IRQn, 0, 0</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text">;</span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"></span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/* Initialize all configured peripherals */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-m0">MX_GPIO_Init</span
                    ><span class="enlighter-g1">()</span
                    ><span class="enlighter-text">;</span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-m0">MX_ADC1_Init</span
                    ><span class="enlighter-g1">()</span
                    ><span class="enlighter-text">;</span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"></span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* USER CODE BEGIN 2 */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"></span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* USER CODE END 2 */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"></span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* Infinite loop */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1"
                      >/* USER CODE BEGIN WHILE */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-k1">while</span
                    ><span class="enlighter-text"> </span
                    ><span class="enlighter-g1">(</span
                    ><span class="enlighter-text">1</span
                    ><span class="enlighter-g1">)</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-g1">{</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* USER CODE END WHILE */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"></span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* USER CODE BEGIN 3 */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-g1">}</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"> </span
                    ><span class="enlighter-c1">/* USER CODE END 3 */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-g1">}</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"></span></div>
                </div>
                <div class="">
                  <div><span class="enlighter-text"></span></div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-c1"
                      >/***************************************************************************************/</span
                    >
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                /***************************************************************************************/
                int main(void) { /* USER CODE BEGIN 1 */ /* USER CODE END 1 */
                /* MCU
                Configuration----------------------------------------------------------*/
                /* Reset of all peripherals, Initializes the Flash interface and
                the Systick. */ HAL_Init(); /* Configure the system clock */
                SystemClock_Config(); /* System interrupt init*/ /* Sets the
                priority grouping field */
                HAL_NVIC_SetPriorityGrouping(NVIC_PRIORITYGROUP_0);
                HAL_NVIC_SetPriority(SysTick_IRQn, 0, 0); /* Initialize all
                configured peripherals */ MX_GPIO_Init(); MX_ADC1_Init(); /*
                USER CODE BEGIN 2 */ /* USER CODE END 2 */ /* Infinite loop */
                /* USER CODE BEGIN WHILE */ while (1) { /* USER CODE END WHILE
                */ /* USER CODE BEGIN 3 */ } /* USER CODE END 3 */ }
                /***************************************************************************************/
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="c"
              data-enlighter-theme=""
              data-enlighter-highlight=""
              data-enlighter-linenumbers=""
              data-enlighter-lineoffset=""
              data-enlighter-title=""
              data-enlighter-group=""
            >
/***************************************************************************************/
              int main(void)
              {
              
                /* USER CODE BEGIN 1 */
              
                /* USER CODE END 1 */
              
                /* MCU Configuration----------------------------------------------------------*/
              
                /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
                HAL_Init();
              
                /* Configure the system clock */
                SystemClock_Config();
              
                /* System interrupt init*/
                /* Sets the priority grouping field */
                HAL_NVIC_SetPriorityGrouping(NVIC_PRIORITYGROUP_0);
                HAL_NVIC_SetPriority(SysTick_IRQn, 0, 0);
              
                /* Initialize all configured peripherals */
                MX_GPIO_Init();
                MX_ADC1_Init();
              
                /* USER CODE BEGIN 2 */
              
                /* USER CODE END 2 */
              
                /* Infinite loop */
                /* USER CODE BEGIN WHILE */
                while (1)
                {
                  /* USER CODE END WHILE */
              
                  /* USER CODE BEGIN 3 */
                }
                /* USER CODE END 3 */
              }
              
              
              /***************************************************************************************/</pre
            >

            <p>В функции</p>
            <div
              class="enlighter-default enlighter-v-inline enlighter-t-godzilla"
            >
              <span class="enlighter"
                ><span class="enlighter-m0">main</span
                ><span class="enlighter-g1">()</span></span
              >
            </div>
            <code
              data-enlighter-language="generic"
              class="EnlighterJSRAW enlighter-origin"
              >main()</code
            >
            вызываются
            <div
              class="enlighter-default enlighter-v-inline enlighter-t-godzilla"
            >
              <span class="enlighter"
                ><span class="enlighter-m0">MX_GPIO_Init</span
                ><span class="enlighter-g1">()</span></span
              >
            </div>
            <code
              data-enlighter-language="generic"
              class="EnlighterJSRAW enlighter-origin"
              >MX_GPIO_Init()</code
            >
            и
            <div
              class="enlighter-default enlighter-v-inline enlighter-t-godzilla"
            >
              <span class="enlighter"
                ><span class="enlighter-m0">MX_ADC1_Init</span
                ><span class="enlighter-g1">()</span></span
              >
            </div>
            <code
              data-enlighter-language="generic"
              class="EnlighterJSRAW enlighter-origin"
              >MX_ADC1_Init()</code
            >, которые определены в этом же файле. Собственно, в этих функциях и
            содержится инициализация и настройка всей периферии, которую мы
            выбрали при создании проекта в STM32CubeMx. Таким образом, отпадает
            необходимость вручную производить конфигурацию использующихся
            модулей контроллера, все это уже содержится в сгенерированном коде.

            <p>Свой собственный код нужно добавлять внутри секций вида:</p>

            <div
              class="enlighter-default enlighter-v-standard enlighter-t-godzilla enlighter-hover enlighter-linenumbers enlighter-overflow-scroll"
            >
              <div class="enlighter-toolbar-top enlighter-toolbar">
                <div
                  class="enlighter-btn enlighter-btn-raw"
                  title="Plain text"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-copy"
                  title="Copy to clipboard"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-window"
                  title="Open code in new window"
                ></div>
                <div
                  class="enlighter-btn enlighter-btn-website"
                  title="EnlighterJS 3 Syntax Highlighter"
                ></div>
              </div>
              <div class="enlighter">
                <div class="">
                  <div>
                    <span class="enlighter-c1">/* USER CODE BEGIN 2 */</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-c0"
                      >// Здесь пользовательская программа</span
                    ><span class="enlighter-text"></span>
                  </div>
                </div>
                <div class="">
                  <div>
                    <span class="enlighter-text"></span
                    ><span class="enlighter-c1">/* USER CODE END 2 */</span>
                  </div>
                </div>
              </div>
              <div class="enlighter-raw">
                /* USER CODE BEGIN 2 */ // Здесь пользовательская программа /*
                USER CODE END 2 */
              </div>
              <div class="enlighter-toolbar-bottom enlighter-toolbar"></div>
            </div>
            <pre
              class="EnlighterJSRAW enlighter-origin"
              data-enlighter-language="c"
              data-enlighter-theme=""
              data-enlighter-highlight=""
              data-enlighter-linenumbers=""
              data-enlighter-lineoffset=""
              data-enlighter-title=""
              data-enlighter-group=""
            >
/* USER CODE BEGIN 2 */
              // Здесь пользовательская программа
              /* USER CODE END 2 */</pre
            >

            <p>
              Тогда при изменении проекта в CubeMx пользовательская часть
              программы будет автоматически перенесена и в заново
              сгенерированные файлы 👍
            </p>

            <p>
              Резюмируем - таким вот образом мы получаем инструмент, который
              позволяет через интуитивно понятный интерфейс выполнить настройку
              любых модулей микроконтроллера. В результате генерации кода мы, в
              свою очередь, получаем готовый проект, в котором уже настроено,
              все что было ранее выбрано в CubeMx. И мы можем дополнять этот
              проект своим функционалом, используя уже сконфигурированные
              автоматически периферийные модули.
            </p>
          </div>
        </div>
      </div>
    </main>
  </body>
</html>
